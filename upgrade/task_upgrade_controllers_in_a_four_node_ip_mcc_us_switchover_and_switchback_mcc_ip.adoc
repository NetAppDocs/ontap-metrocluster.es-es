---
permalink: upgrade/task_upgrade_controllers_in_a_four_node_ip_mcc_us_switchover_and_switchback_mcc_ip.html 
sidebar: sidebar 
keywords: metrocluster, upgrade, controller, ip, configuration, switchover, switchback, workflow, nodes, tiebreaker, verify, bootrage, root, aggregate, disks 
summary: 'A partir de ONTAP 9.8, puede utilizar la operación de conmutación de sitios de MetroCluster para ofrecer servicios no disruptivos a los clientes mientras se actualizan los módulos de controladoras del clúster de partners. Como parte de este procedimiento, no se pueden actualizar otros componentes (como bandejas de almacenamiento o switches).' 
---
= Actualización de controladoras en una configuración IP de MetroCluster mediante conmutación de sitios y conmutación de estado (ONTAP 9.8 y versiones posteriores)
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
A partir de ONTAP 9.8, puede utilizar la operación de conmutación de sitios de MetroCluster para ofrecer servicios no disruptivos a los clientes mientras se actualizan los módulos de controladoras del clúster de partners. Como parte de este procedimiento, no se pueden actualizar otros componentes (como bandejas de almacenamiento o switches).



== Plataformas compatibles con este procedimiento

* Las plataformas deben ejecutar ONTAP 9.8 o una versión posterior.
* La plataforma de destino (nueva) debe ser un modelo diferente al de la plataforma original.
* Solo puede actualizar modelos de plataforma específicos mediante este procedimiento en una configuración IP de MetroCluster.
+
** Para obtener información acerca de las combinaciones de actualización de plataforma compatibles, consulte la tabla de actualización IP de MetroCluster en link:concept_choosing_controller_upgrade_mcc.html["Elija un procedimiento de actualización de la controladora"].
+
Consulte https://docs.netapp.com/us-en/ontap-metrocluster/upgrade/concept_choosing_controller_upgrade_mcc.html#choosing-a-procedure-that-uses-the-switchover-and-switchback-process["Seleccione un método de actualización o actualización"] para procedimientos adicionales.







== Acerca de esta tarea

* Este procedimiento se aplica a los módulos de la controladora en una configuración de IP de MetroCluster.
* Todas las controladoras de la configuración deben actualizarse durante el mismo período de mantenimiento.
+
No se puede utilizar la configuración MetroCluster con diferentes tipos de controladoras fuera de esta actividad de mantenimiento.

* Los switches IP de MetroCluster (tipo de switch, proveedor y modelo) y la versión de firmware deben ser compatibles con las controladoras nuevas y existentes en la configuración de actualización.
+
Consulte link:https://hwu.netapp.com["Hardware Universe de NetApp"^] o la link:https://imt.netapp.com/matrix/["IMT"^] para conocer las versiones de firmware y switches compatibles.

* Si está activada en el sistema, link:../maintain/task-configure-encryption.html#disable-end-to-end-encryption["deshabilite el cifrado integral"] antes de realizar la actualización.
* Si la plataforma nueva tiene menos ranuras que el sistema original, o si tiene menos puertos o diferentes tipos, puede que necesite agregar un adaptador al nuevo sistema.
* Puede reutilizar las direcciones IP, máscaras de red y puertas de enlace de las plataformas originales en las nuevas plataformas.


En este procedimiento se utilizan los nombres de ejemplo siguientes:

* Sitio_a
+
** Antes de la actualización:
+
*** Node_a_1-old
*** Node_A_2-old


** Después de la actualización:
+
*** Node_A_1-new
*** Node_A_2-New




* Centro_B
+
** Antes de la actualización:
+
*** Node_B_1-old
*** Node_B_2-old


** Después de la actualización:
+
*** Node_B_1-New
*** Node_B_2-New








== Active el registro de la consola

NetApp recomienda encarecidamente que habilite el inicio de sesión de la consola en los dispositivos que esté utilizando y realice las siguientes acciones al realizar este procedimiento:

* Deje la función AutoSupport habilitada durante el mantenimiento.
* Active un mensaje de AutoSupport de mantenimiento antes y después de las tareas de mantenimiento para deshabilitar la creación de casos durante la actividad de mantenimiento.
+
Consulte el artículo de la base de conocimientos link:https://kb.netapp.com/Support_Bulletins/Customer_Bulletins/SU92["Cómo impedir la creación automática de casos durante las ventanas de mantenimiento programado"^].

* Habilite el registro de sesiones para cualquier sesión de CLI. Para obtener instrucciones sobre cómo activar el registro de sesiones, consulte la sección Salida de sesión de registro en el artículo de la Base de conocimientos link:https://kb.netapp.com/on-prem/ontap/Ontap_OS/OS-KBs/How_to_configure_PuTTY_for_optimal_connectivity_to_ONTAP_systems["Cómo configurar PuTTY para una conectividad óptima con sistemas ONTAP"^].




== Defina el inicio necesario en el sistema existente

Si va a actualizar a un sistema AFF A70, AFF A90 o AFF A1K, siga los pasos para configurar el `hw.cxgbe.toe_keepalive_disable=1` arranque.


CAUTION: Si va a actualizar a un sistema AFF A70, AFF A90 o AFF A1K, * debe * completar esta tarea antes de realizar la actualización. Esta tarea *solamente* se aplica a las actualizaciones a un sistema AFF A70, AFF A90 o AFF A1K desde un sistema compatible. Para todas las demás actualizaciones, puede omitir esta tarea e ir directamente a <<prepare_so_sb_upgrade,Prepare la actualización>>.

.Pasos
. Detenga un nodo en cada sitio y permita que su compañero de alta disponibilidad realice una toma de control de almacenamiento del nodo:
+
`halt  -node <node_name>`

. En `LOADER` el símbolo del sistema del nodo detenido, introduzca lo siguiente:
+
`setenv hw.cxgbe.toe_keepalive_disable 1`

+
`saveenv`

+
`printenv hw.cxgbe.toe_keepalive_disable`

. Arrancar el nodo:
+
`boot_ontap`

. Cuando el nodo arranque, realice un retorno al nodo en el símbolo del sistema:
+
`storage failover giveback -ofnode <node_name>`

. Repita los pasos en cada nodo del grupo de recuperación ante desastres que se esté actualizando.




== Prepare la actualización

Antes de realizar cambios en la configuración existente de MetroCluster, debe comprobar el estado de la configuración, preparar las nuevas plataformas y realizar otras tareas diversas.



=== Flujo de trabajo para actualizar controladoras en una configuración de IP de MetroCluster

Puede usar el diagrama de flujo de trabajo como ayuda para planificar las tareas de actualización.

image::../media/workflow_ip_upgrade.png[actualización de ip de flujo de trabajo]



=== Actualice los archivos RCF del switch MetroCluster antes de actualizar las controladoras

Dependiendo de los modelos de plataforma antiguos, o si la configuración del switch no está en la versión mínima, o si desea cambiar los identificadores de VLAN utilizados por las conexiones MetroCluster back-end, debe actualizar los archivos RCF del switch antes de iniciar el procedimiento de actualización de la plataforma.

.Acerca de esta tarea
Debe actualizar el archivo RCF en las siguientes situaciones:

* Para determinados modelos de plataforma, los switches deben utilizar un identificador de VLAN compatible para las conexiones IP de MetroCluster back-end. Si los modelos de plataforma nuevos o antiguos se encuentran en la siguiente tabla, *y no* utilizando un identificador de VLAN admitido, deberá actualizar los archivos RCF del conmutador.
+

NOTE: Las conexiones de clúster local pueden utilizar cualquier VLAN; no es necesario que estén en el rango determinado.

+
|===


| Modelo de plataforma (antiguo o nuevo) | ID de VLAN compatibles 


 a| 
** AFF A400

 a| 
** 10
** 20
** Cualquier valor en el rango 101 a 4096 inclusive.


|===
* La configuración del conmutador no se configuró con la versión RCF mínima admitida:
+
|===


| Modelo de switch | Versión de archivo RCF necesaria 


 a| 
Cisco 3132Q-V
 a| 
1.7 o posterior



 a| 
Cisco 3232C
 a| 
1.7 o posterior



 a| 
Broadcom BES-53248
 a| 
1.3 o posterior

|===
* Desea cambiar la configuración de VLAN.
+
El intervalo del ID de VLAN es de 101 a 4096 incluido.



Los switches de Site_A se actualizarán cuando se actualicen las controladoras de Site_A.

.Pasos
. Prepare los switches IP para la aplicación de los nuevos archivos RCF.
+
Siga los pasos de la sección para su proveedor de switches:

+
** link:../install-ip/task_switch_config_broadcom.html#resetting-the-broadcom-ip-switch-to-factory-defaults["Restablezca el conmutador IP Broadcom a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_cisco.html#resetting-the-cisco-ip-switch-to-factory-defaults["Restablezca el conmutador IP de Cisco a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_nvidia.html#reset-the-nvidia-ip-sn2100-switch-to-factory-defaults["Restablece el switch NVIDIA IP SN2100 a los valores predeterminados de fábrica"]


. Descargue e instale los archivos RCF.
+
Siga los pasos de la sección para su proveedor de switches:

+
** link:../install-ip/task_switch_config_broadcom.html#downloading-and-installing-the-broadcom-rcf-files["Descargue e instale los archivos Broadcom RCF"]
** link:../install-ip/task_switch_config_cisco.html#downloading-and-installing-the-cisco-ip-rcf-files["Descargue e instale los archivos Cisco IP RCF"]
** link:../install-ip/task_switch_config_nvidia.html#download-and-install-the-nvidia-rcf-files["Descargue e instale los archivos NVIDIA IP RCF"]






=== Asigne puertos de los nodos antiguos a los nuevos

Debe verificar que los puertos físicos de node_A_1-old se asignan correctamente a los puertos físicos en node_A_1-new, que permitirá que node_A_1-new se comunique con otros nodos del clúster y con la red después de la actualización.

.Acerca de esta tarea
Cuando el nuevo nodo se arranque por primera vez durante el proceso de actualización, reproducirá la configuración más reciente del nodo antiguo al que desea sustituir. Cuando arranca node_A_1-new, ONTAP intenta alojar LIF en los mismos puertos que se usaron en el node_A_1-old. Por lo tanto, como parte de la actualización debe ajustar la configuración de puerto y LIF para que sea compatible con la del nodo antiguo. Durante el procedimiento de actualización, deberá realizar los pasos tanto en los nodos antiguos como en los nuevos para garantizar que la configuración correcta de LIF de datos, gestión y clúster.

En la siguiente tabla se muestran ejemplos de cambios de configuración relacionados con los requisitos de puerto de los nuevos nodos.

|===


3+| Puertos físicos de Cluster Interconnect 


| La controladora anterior | Nueva controladora | Acción requerida 


 a| 
e0a y e0b
 a| 
e3a, e3b
 a| 
No hay puerto que coincida. Después de la actualización, debe volver a crear los puertos del clúster.



 a| 
e0c, e0d
 a| 
e0a, e0b, e0c y e0d
 a| 
los puertos e0c y e0d son coincidentes. No tiene que cambiar la configuración, pero tras la actualización puede propagar las LIF del clúster a través de los puertos de clúster disponibles.

|===
.Pasos
. Determine qué puertos físicos están disponibles en las nuevas controladoras y qué LIF se pueden alojar en los puertos.
+
El uso del puerto de la controladora depende del módulo de la plataforma y de los switches que se usarán en la configuración IP de MetroCluster. Puede recopilar el uso del puerto de las nuevas plataformas desde la link:https://hwu.netapp.com["Hardware Universe de NetApp"].

. Planifique el uso de su puerto y rellene las siguientes tablas como referencia para cada uno de los nodos nuevos.
+
Consulte la tabla a medida que lleve a cabo el procedimiento de actualización.

+
|===


|  3+| Node_a_1-old 3+| Node_A_1-new 


| LUN | Puertos | Espacios IP | Dominios de retransmisión | Puertos | Espacios IP | Dominios de retransmisión 


 a| 
Clúster 1
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Clúster 2
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Clúster 3
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Clúster 4
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Gestión de nodos
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Gestión de clústeres
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Datos 1
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Datos 2
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Datos 3
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Datos 4
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
SAN
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 



 a| 
Puerto de interconexión de clústeres
 a| 
 a| 
 a| 
 a| 
 a| 
 a| 

|===




=== Arranque por red las nuevas controladoras

Después de instalar los nodos nuevos, debe reiniciar el sistema para asegurarse de que los nuevos nodos estén ejecutando la misma versión de ONTAP que los nodos originales. El término arranque desde red significa que se arranca desde una imagen ONTAP almacenada en un servidor remoto. Al prepararse para reiniciar el sistema, debe colocar una copia de la imagen de arranque ONTAP 9 en un servidor web al que pueda acceder el sistema.

.Pasos
. Reiniciar el sistema de las nuevas controladoras:
+
.. Acceda a https://mysupport.netapp.com/site/["Sitio de soporte de NetApp"] para descargar los archivos utilizados para realizar el arranque desde red del sistema.
.. Descargue el software ONTAP adecuado de la sección de descarga de software del sitio de soporte de NetApp y almacene el `ontap-version_image.tgz` archivo en un directorio accesible a través de la web.
.. Cambie al directorio accesible a la Web y compruebe que los archivos que necesita están disponibles.
+
El listado de directorios debe contener una carpeta netboot con un archivo de kernel:

+
`_ontap-version_image.tgz`

+
Usted no necesita extraer el `_ontap-version_image.tgz` archivo.

.. En el símbolo del sistema del CARGADOR, configure la conexión para reiniciar el sistema para una LIF de gestión:
+
|===


| Si el direccionamiento IP es... | Realice lo siguiente... 


 a| 
DHCP
 a| 
Configure la conexión automática:

`ifconfig e0M -auto`



 a| 
Estático
 a| 
Configure la conexión manual:

`ifconfig e0M -addr=_ip_addr_ -mask=_netmask_ -gw=_gateway_`

|===
.. Reiniciar el sistema.
+
`netboot \http://_web_server_ip/path_to_web-accessible_directory/ontap-version_image.tgz`

.. En el menú de inicio, seleccione la opción **(7) instale primero el nuevo software** para descargar e instalar la nueva imagen de software en el dispositivo de arranque.
+
Ignore el siguiente mensaje:

+
`"This procedure is not supported for Non-Disruptive Upgrade on an HA pair"`. Se aplica a las actualizaciones no disruptivas del software, no a las actualizaciones de controladoras.

.. Si se le solicita que continúe el procedimiento, introduzca `y`Y cuando se le solicite el paquete, escriba la dirección URL del archivo de imagen:
+
`http://__web_server_ip/path_to_web-accessible_directory/ontap-version___image.tgz`

.. Introduzca el nombre de usuario y la contraseña, si procede, o pulse Intro para continuar.
.. No olvide entrar `n` para omitir la recuperación de backup cuando observe un símbolo del sistema similar a lo siguiente:
+
[listing]
----
Do you want to restore the backup configuration now? {y|n} n
----
.. Reinicie introduciendo `*y*` cuando vea un símbolo del sistema similar a lo siguiente:
+
[listing]
----
The node must be rebooted to start using the newly installed software. Do you want to reboot now? {y|n}
----






=== Borrar la configuración de un módulo de controlador

[role="lead"]
Antes de utilizar un nuevo módulo de controladora en la configuración de MetroCluster, debe borrar la configuración existente.

.Pasos
. Si es necesario, detenga el nodo para mostrar el símbolo del sistema del CARGADOR:
+
`halt`

. En el símbolo del sistema del CARGADOR, establezca las variables de entorno en los valores predeterminados:
+
`set-defaults`

. Guarde el entorno:
+
`saveenv`

. En el símbolo del sistema del CARGADOR, inicie el menú de arranque:
+
`boot_ontap menu`

. En el símbolo del sistema del menú de inicio, borre la configuración:
+
`wipeconfig`

+
Responda `yes` a la solicitud de confirmación.

+
El nodo se reinicia y el menú de arranque se muestra de nuevo.

. En el menú de inicio, seleccione la opción *5* para arrancar el sistema en modo de mantenimiento.
+
Responda `yes` a la solicitud de confirmación.





=== Verifique el estado de MetroCluster antes de la actualización del sitio

Debe verificar el estado y la conectividad de la configuración de MetroCluster antes de realizar la actualización.

.Pasos
. Compruebe el funcionamiento de la configuración de MetroCluster en ONTAP:
+
.. Compruebe si los nodos tienen rutas múltiples: +
`node run -node <node_name> sysconfig -a`
+
Debe emitir este comando para cada nodo en la configuración de MetroCluster.

.. Verificar que no hay discos rotos en la configuración: +
`storage disk show -broken`
+
Debe emitir este comando en cada nodo de la configuración de MetroCluster.

.. Compruebe cualquier alerta de estado:
+
`system health alert show`

+
Debe emitir este comando en cada clúster.

.. Verifique las licencias en los clústeres:
+
`system license show`

+
Debe emitir este comando en cada clúster.

.. Compruebe los dispositivos conectados a los nodos:
+
`network device-discovery show`

+
Debe emitir este comando en cada clúster.

.. Compruebe que la zona horaria y la hora están configuradas correctamente en ambos sitios:
+
`cluster date show`

+
Debe emitir este comando en cada clúster. Puede utilizar el `cluster date` para configurar la hora y la zona horaria.



. Confirmar el modo operativo de la configuración de MetroCluster y realizar una comprobación de MetroCluster.
+
.. Confirme la configuración del MetroCluster y que el modo operativo es `normal`: +
`metrocluster show`
.. Confirme que se muestran todos los nodos esperados: +
`metrocluster node show`
.. Emita el siguiente comando:
+
`metrocluster check run`

.. Mostrar los resultados de la comprobación de MetroCluster:
+
`metrocluster check show`



. Compruebe el cableado MetroCluster con la herramienta Config Advisor.
+
.. Descargue y ejecute Config Advisor.
+
https://mysupport.netapp.com/site/tools/tool-eula/activeiq-configadvisor["Descargas de NetApp: Config Advisor"]

.. Después de ejecutar Config Advisor, revise el resultado de la herramienta y siga las recomendaciones del resultado para solucionar los problemas detectados.






=== Recopile información antes de la actualización

Antes de la actualización, debe recopilar información para cada uno de los nodos y, si fuera necesario, ajustar los dominios de retransmisión de red, quitar las VLAN y los grupos de interfaces, y recopilar información sobre el cifrado.

.Pasos
. Registre el cableado físico de cada nodo y etiquetando los cables según sea necesario para permitir el cableado correcto de los nuevos nodos.
. Recopile información sobre las interconexiones, los puertos y las LIF de cada nodo.
+
Debe recopilar el resultado de los siguientes comandos para cada nodo:

+
** `metrocluster interconnect show`
** `metrocluster configuration-settings connection show`
** `network interface show -role cluster,node-mgmt`
** `network port show -node <node_name> -type physical`
** `network port vlan show -node <node_name>`
** `network port ifgrp show -node <node_name> -instance`
** `network port broadcast-domain show`
** `network port reachability show -detail`
** `network ipspace show`
** `volume show`
** `storage aggregate show`
** `system node run -node <node_name> sysconfig -a`
** `aggr show -r`
** `disk show`
** `system node run <node-name> disk show`
** `vol show -fields type`
** `vol show -fields type , space-guarantee`
** `vserver fcp initiator show`
** `storage disk show`
** `metrocluster configuration-settings interface show`


. Recopile los UUID para el sitio_B (el sitio cuyas plataformas se están actualizando actualmente):
+
`metrocluster node show -fields node-cluster-uuid, node-uuid`

+
Estos valores deben configurarse con precisión en los nuevos módulos del controlador Site_B para garantizar que la actualización se realice correctamente. Copie los valores en un archivo para poder copiarlos en los comandos adecuados más adelante en el proceso de actualización.

+
En el ejemplo siguiente se muestra la salida del comando con los UUID:

+
[listing]
----
cluster_B::> metrocluster node show -fields node-cluster-uuid, node-uuid
  (metrocluster node show)
dr-group-id cluster     node   node-uuid                            node-cluster-uuid
----------- --------- -------- ------------------------------------ ------------------------------
1           cluster_A node_A_1 f03cb63c-9a7e-11e7-b68b-00a098908039 ee7db9d5-9a82-11e7-b68b-00a098908039
1           cluster_A node_A_2 aa9a7a7a-9a81-11e7-a4e9-00a098908c35 ee7db9d5-9a82-11e7-b68b-00a098908039
1           cluster_B node_B_1 f37b240b-9ac1-11e7-9b42-00a098c9e55d 07958819-9ac6-11e7-9b42-00a098c9e55d
1           cluster_B node_B_2 bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f 07958819-9ac6-11e7-9b42-00a098c9e55d
4 entries were displayed.
cluster_B::*
----
+
Es recomendable que registre los UUID en una tabla similar a la siguiente.

+
|===


| Clúster o nodo | UUID 


 a| 
Cluster_B
 a| 
07958819-9ac6-11e7-9b42-00a098c9e55d



 a| 
Node_B_1
 a| 
f37b240b-9ac1-11e7-9b42-00a098c9e55d



 a| 
Node_B_2
 a| 
bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f



 a| 
Cluster_a
 a| 
ee7db9d5-9a82-11e7-b68b-00a098908039



 a| 
Node_a_1
 a| 
f03cb63c-9a7e-11e7-b68b-00a098908039



 a| 
Node_A_2
 a| 
aa9a7a7a-9a81-11e7-a4e9-00a098908c35

|===
. Si los nodos MetroCluster tienen una configuración SAN, recopile la información pertinente.
+
Debe recopilar el resultado de los siguientes comandos:

+
** `fcp adapter show -instance`
** `fcp interface show -instance`
** `iscsi interface show`
** `ucadmin show`


. Si el volumen raíz está cifrado, recopile y guarde la clave de acceso usada para Key-Manager:
+
`security key-manager backup show`

. Si los nodos de MetroCluster utilizan el cifrado de volúmenes o agregados, copie información sobre las claves y las Passphrases.
+
Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-1677AE0A-FEF7-45FA-8616-885AA3283BCF.html["Realizar un backup manual de la información de gestión de claves incorporada"].

+
.. Si el gestor de claves incorporado está configurado: +
`security key-manager onboard show-backup`
+
Necesitará la contraseña más adelante en el procedimiento de actualización.

.. Si está configurada la gestión de claves empresariales (KMIP), ejecute los siguientes comandos:
+
`security key-manager external show -instance`
`security key-manager key query`



. Recopile los ID del sistema de los nodos existentes:
+
`metrocluster node show -fields node-systemid,ha-partner-systemid,dr-partner-systemid,dr-auxiliary-systemid`

+
La siguiente salida muestra las unidades reasignadas.

+
[listing]
----
::> metrocluster node show -fields node-systemid,ha-partner-systemid,dr-partner-systemid,dr-auxiliary-systemid

dr-group-id cluster     node     node-systemid ha-partner-systemid dr-partner-systemid dr-auxiliary-systemid
----------- ----------- -------- ------------- ------------------- ------------------- ---------------------
1           cluster_A node_A_1   537403324     537403323           537403321           537403322
1           cluster_A node_A_2   537403323     537403324           537403322           537403321
1           cluster_B node_B_1   537403322     537403321           537403323           537403324
1           cluster_B node_B_2   537403321     537403322           537403324           537403323
4 entries were displayed.
----




=== Elimine la supervisión de Mediator o tiebreaker

Antes de actualizar las plataformas, debe eliminar la supervisión si la configuración de MetroCluster se supervisa con tiebreaker o la utilidad Mediator.

.Pasos
. Recopile el resultado del siguiente comando:
+
`storage iscsi-initiator show`

. Elimine la configuración de MetroCluster existente de tiebreaker, Mediator u otro software que pueda iniciar la conmutación.
+
|===


| Si está usando... | Utilice este procedimiento... 


 a| 
Tiebreaker
 a| 
link:../tiebreaker/concept_configuring_the_tiebreaker_software.html#removing-metrocluster-configurations["Eliminar las configuraciones de MetroCluster"]



 a| 
Mediador
 a| 
Ejecute el siguiente comando desde el símbolo del sistema de ONTAP:

`metrocluster configuration-settings mediator remove`



 a| 
Aplicaciones de terceros
 a| 
Consulte la documentación del producto.

|===




=== Envíe un mensaje de AutoSupport personalizado antes de realizar el mantenimiento

Antes de realizar el mantenimiento, debe emitir un mensaje de AutoSupport para notificar al soporte técnico de NetApp que se está realizando el mantenimiento. Al informar al soporte técnico de que el mantenimiento está en marcha, se evita que abran un caso basándose en que se ha producido una interrupción.

.Acerca de esta tarea
Esta tarea debe realizarse en cada sitio MetroCluster.

.Pasos
. Inicie sesión en el clúster.
. Invoque un mensaje de AutoSupport que indique el inicio del mantenimiento:
+
`system node autosupport invoke -node * -type all -message MAINT=__maintenance-window-in-hours__`

+
La `maintenance-window-in-hours` el parámetro especifica la longitud de la ventana de mantenimiento, con un máximo de 72 horas. Si el mantenimiento se completa antes de que haya transcurrido el tiempo, puede invocar un mensaje de AutoSupport que indique el final del período de mantenimiento:

+
`system node autosupport invoke -node * -type all -message MAINT=end`

. Repita estos pasos en el sitio para partners.




== Cambie la configuración de MetroCluster

Debe cambiar la configuración a site_A para que las plataformas en site_B puedan actualizarse.

.Acerca de esta tarea
Esta tarea debe realizarse en site_A.

Tras completar esta tarea, Cluster_A está activo y está sirviendo datos para ambos sitios. Cluster_B está inactivo y está listo para comenzar el proceso de actualización.

image::../media/mcc_upgrade_cluster_a_in_switchover.png[mcc actualiza el clúster a sin cambio]

.Pasos
. Cambie de la configuración de MetroCluster a site_A para que los nodos de site_B puedan actualizarse:
+
.. Emita el siguiente comando en cluster_A:
+
`metrocluster switchover -controller-replacement true`

+
La operación puede tardar varios minutos en completarse.

.. Supervise la operación de switchover:
+
`metrocluster operation show`

.. Una vez finalizada la operación, confirme que los nodos están en estado de conmutación:
+
`metrocluster show`

.. Compruebe el estado de los nodos de MetroCluster:
+
`metrocluster node show`

+
Reparación automática de los agregados después de deshabilitar la conmutación negociada durante la actualización de la controladora.







== Elimine las configuraciones de la interfaz y desinstale las controladoras antiguas

Compruebe la ubicación de LIF correcta. A continuación, elimine las VLAN y los grupos de interfaces de las controladoras antiguas y desinstale físicamente las controladoras.

.Acerca de esta tarea
* Estos pasos se realizan en las controladoras antiguas (node_B_1-old, node_B_2-old).
* Vea la información recopilada en link:task_upgrade_controllers_in_a_four_node_ip_mcc_us_switchover_and_switchback_mcc_ip.html["Asigne puertos de los nodos antiguos a los nuevos"].


.Pasos
. Arranque los nodos antiguos e inicie sesión en los nodos:
+
`boot_ontap`

. Modifique las LIF de interconexión de clústeres de las controladoras antiguas para que usen un puerto raíz diferente a los puertos utilizados para la interconexión de alta disponibilidad o la interconexión de recuperación ante desastres IP de MetroCluster en las nuevas controladoras.
+

NOTE: Este paso es necesario para una actualización correcta.

+
Las LIF de interconexión de clústeres de las controladoras antiguas deben usar un puerto inicial diferente al de los puertos utilizados para la interconexión de alta disponibilidad o la interconexión de recuperación ante desastres IP de MetroCluster en las nuevas controladoras. Por ejemplo, cuando se actualiza a controladoras AFF A90, los puertos de interconexión de alta disponibilidad son e1a y e7a, y los puertos de interconexión de recuperación ante desastres IP de MetroCluster son E2B y E3b. Debe mover las LIF de interconexión de clústeres de las controladoras anteriores si están alojadas en los puertos e1a, e7a, E2B o E3b.

+
Para la distribución y asignación de puertos en los nuevos nodos, consulte la https://hwu.netapp.com["Hardware Universe de NetApp"].

+
.. En las controladoras antiguas, vea las LIF de interconexión de clústeres:
+
`network interface show  -role intercluster`

+
Una de las siguientes acciones dependerá de si las LIF de interconexión de clústeres de las controladoras anteriores usan los mismos puertos que los utilizados para la interconexión de alta disponibilidad o la interconexión MetroCluster IP DR en las nuevas controladoras.

+
[cols="2*"]
|===
| Si las LIF de interconexión de clústeres... | Vaya a... 


| Utilice el mismo puerto de inicio | <<controller_manual_upgrade_prepare_network_ports_2b,Subpaso b>> 


| Utilice un puerto de inicio diferente | <<controller_manual_upgrade_prepare_network_ports_3,Paso 3>> 
|===
.. [[controller_manual_upgrade_prepare_network_ports_2b]]Modifique las LIF de interconexión de clústeres para utilizar un puerto raíz diferente:
+
`network interface modify -vserver <vserver> -lif <intercluster_lif> -home-port <port-not-used-for-ha-interconnect-or-mcc-ip-dr-interconnect-on-new-nodes>`

.. Compruebe que todas las LIF de interconexión de clústeres se encuentran en sus nuevos puertos principales:
+
`network interface show -role intercluster -is-home  false`

+
El resultado del comando debe estar vacío, lo que indica que todas las LIF de interconexión de clústeres están en sus respectivos puertos principales.

.. Si hay algún LIF que no está en sus puertos raíz, revertiéndolo con el siguiente comando:
+
`network interface revert -lif <intercluster_lif>`

+
Repita el comando para cada LIF de interconexión de clústeres que no esté en el puerto de inicio.



. [[controller_manual_upgrade_prepare_network_ports_3]]Asigne el puerto de inicio de todas las LIF de datos de la controladora antigua a un puerto común que sea el mismo en los módulos de controladora antiguos y nuevos.
+

CAUTION: Si las controladoras antigua y nueva no disponen de un puerto común, no necesitará modificar las LIF de datos. Sáltese este paso y vaya directamente a <<upgrades_manual_without_matching_ports,Paso 4>>.

+
.. Mostrar las LIF:
+
`network interface show`

+
Todos los LIF de datos, incluidos SAN y NAS, estarán admin arriba y operativamente inactivos ya que estos están en el sitio de conmutación (cluster_A).

.. Revise el resultado para encontrar un puerto de red física común que sea el mismo en las controladoras anterior y nueva que no se use como puerto de clúster.
+
Por ejemplo, e0d es un puerto físico de las controladoras antiguas y también está presente en las nuevas controladoras. e0d no se utiliza como puerto de clúster ni de otro modo en las nuevas controladoras.

+
Para el uso de puertos para los modelos de plataforma, consulte https://hwu.netapp.com/["Hardware Universe de NetApp"]

.. Modifique todas las LIFS de datos para utilizar el puerto común como puerto de inicio: +
`network interface modify -vserver <svm-name> -lif <data-lif> -home-port <port-id>`
+
En el siguiente ejemplo, es «e0d».

+
Por ejemplo:

+
[listing]
----
network interface modify -vserver vs0 -lif datalif1 -home-port e0d
----


. [[upgrades_manual_without_matching_ports]] Modifique los dominios de difusión para eliminar la VLAN y los puertos físicos que deben eliminarse:
+
`broadcast-domain remove-ports -broadcast-domain <broadcast-domain-name> -ports <node-name:port-id>`

+
Repita este paso para todos los puertos VLAN y físicos.

. Quite todos los puertos VLAN que utilicen puertos de clúster como puertos miembro e ifgrps usando puertos de clúster como puertos miembro.
+
.. Suprimir puertos VLAN: +
`network port vlan delete -node <node_name> -vlan-name <portid-vlandid>`
+
Por ejemplo:

+
[listing]
----
network port vlan delete -node node1 -vlan-name e1c-80
----
.. Quite puertos físicos de los grupos de interfaces:
+
`network port ifgrp remove-port -node <node_name> -ifgrp <interface-group-name> -port <portid>`

+
Por ejemplo:

+
[listing]
----
network port ifgrp remove-port -node node1 -ifgrp a1a -port e0d
----
.. Quite puertos VLAN y de grupo de interfaces del dominio de retransmisión:
+
`network port broadcast-domain remove-ports -ipspace <ipspace> -broadcast-domain <broadcast-domain-name> -ports <nodename:portname,nodename:portnamee>,..`

.. Modifique los puertos de grupo de interfaces para que utilicen otros puertos físicos como miembro, según sea necesario:
+
`ifgrp add-port -node <node_name> -ifgrp <interface-group-name> -port <port-id>`



. Detenga los nodos del símbolo del sistema del CARGADOR:
+
`halt -inhibit-takeover true`

. Conéctese a la consola de serie de las controladoras antiguas (node_B_1-old y node_B_2-old) en Site_B y compruebe que muestra el aviso DEL CARGADOR.
. Recopile los valores bootarg:
+
`printenv`

. Desconecte las conexiones de almacenamiento y red de node_B_1-old y node_B_2-old y etiquete los cables para que puedan volver a conectarse a los nodos nuevos.
. Desconecte los cables de alimentación de node_B_1-old y node_B_2-old.
. Quite las controladoras node_B_1-old y node_B_2-old del rack.




=== Configure las nuevas controladoras

Debe montar en rack y cablear las nuevas controladoras.

.Pasos
. Planifique la colocación de los nuevos módulos de controladora y bandejas de almacenamiento según sea necesario.
+
El espacio en rack depende del modelo de plataforma de los módulos de la controladora, los tipos de switch y el número de bandejas de almacenamiento de la configuración.

. Puesta a tierra apropiadamente usted mismo.
. Si la actualización requiere reemplazar los módulos de la controladora, por ejemplo, actualizar de un sistema AFF 800 a un sistema AFF A90, debe quitar el módulo de la controladora del chasis cuando sustituya el módulo de la controladora. Para todas las demás actualizaciones, vaya a <<ip_upgrades_so_sb_4,Paso 4>>.
+
En la parte frontal del chasis, utilice los pulgares para empujar con firmeza cada unidad hasta que sienta una parada positiva. Esto confirma que las unidades están firmemente asentadas contra el plano medio del chasis.

+
image::../media/drw_a800_drive_seated.png[Muestra cómo quitar el módulo de controladora del chasis]

. [[ip_upgrades_so_sb_4]] Instale los módulos del controlador.
+

NOTE: Los pasos siguientes de instalación dependen de si su actualización requiere la sustitución de los módulos del controlador, como una actualización de un sistema AFF 800 a un sistema AFF A90.

+
[role="tabbed-block"]
====
.Reemplazando módulos de controlador
--
La instalación de las controladoras nuevas no es aplicable en las actualizaciones de sistemas integrados con discos y controladoras en el mismo chasis, por ejemplo, de un sistema AFF A800 a un sistema AFF A90. Los nuevos módulos de controladora y tarjetas I/O se deben intercambiar tras apagar las controladoras antiguas, como se muestra en la imagen siguiente.

La siguiente imagen de ejemplo es solo para representación. Los módulos de la controladora y las tarjetas I/O pueden variar de un sistema a otro.

image::../media/a90_a70_pcm_swap.png[Muestra el intercambio del módulo del controlador]

--
.Todas las demás actualizaciones
--
Instale los módulos de la controladora en el rack o armario.

--
====
. Conecte los cables de alimentación, consola de serie y conexiones de gestión de las controladoras tal como se describe en link:../install-ip/using_rcf_generator.html["Cableado de los switches IP de MetroCluster"]
+
No conecte ningún otro cable que esté desconectado de las controladoras antiguas en este momento.

+
https://docs.netapp.com/us-en/ontap-systems/index.html["Documentación de los sistemas de hardware de ONTAP"^]

. Encienda los nodos nuevos y arranque en modo de mantenimiento.




=== Restaure la configuración de HBA

Dependiendo de la presencia y configuración de tarjetas HBA en el módulo de controlador, debe configurarlas correctamente para el uso de su sitio.

.Pasos
. En el modo de mantenimiento configure los ajustes para cualquier HBA del sistema:
+
.. Compruebe la configuración actual de los puertos:
+
`ucadmin show`

.. Actualice la configuración del puerto según sea necesario.


+
|===


| Si tiene este tipo de HBA y el modo que desea... | Se usa este comando... 


 a| 
CNA FC
 a| 
`ucadmin modify -m fc -t initiator <adapter-name>`



 a| 
Ethernet de CNA
 a| 
`ucadmin modify -mode cna <adapter-name>`



 a| 
Destino FC
 a| 
`fcadmin config -t target <adapter-name>`



 a| 
Iniciador FC
 a| 
`fcadmin config -t initiator <adapter-name>`

|===
. Salir del modo de mantenimiento:
+
`halt`

+
Después de ejecutar el comando, espere hasta que el nodo se detenga en el símbolo del sistema DEL CARGADOR.

. Vuelva a arrancar el nodo en modo de mantenimiento para permitir que los cambios de configuración surtan efecto:
+
`boot_ontap maint`

. Compruebe los cambios realizados:
+
|===


| Si tiene este tipo de HBA... | Se usa este comando... 


 a| 
CNA
 a| 
`ucadmin show`



 a| 
FC
 a| 
`fcadmin show`

|===




=== Establezca el estado de alta disponibilidad en las controladoras y el chasis nuevos

Debe comprobar el estado de alta disponibilidad de las controladoras y el chasis y, si es necesario, actualizar el estado para que coincida con la configuración del sistema.

.Pasos
. En el modo de mantenimiento, muestre el estado de alta disponibilidad del módulo de controladora y el chasis:
+
`ha-config show`

+
El estado de alta disponibilidad para todos los componentes debe ser `mccip`.

. Si el estado del sistema mostrado de la controladora o el chasis no es correcto, establezca el estado de alta disponibilidad:
+
`ha-config modify controller mccip`

+
`ha-config modify chassis mccip`

. Verifique y modifique los puertos Ethernet conectados a bandejas NS224 o switches de almacenamiento.
+
.. Compruebe los puertos Ethernet conectados a las bandejas NS224 o los switches de almacenamiento:
+
`storage port show`

.. Establezca todos los puertos Ethernet conectados a bandejas Ethernet o switches de almacenamiento, incluidos los switches compartidos para almacenamiento y clúster, en `storage` modo:
+
`storage port modify -p <port> -m storage`

+
Ejemplo:

+
[listing]
----
*> storage port modify -p e5b -m storage
Changing NVMe-oF port e5b to storage mode
----
+

NOTE: Esto debe establecerse en todos los puertos afectados para que la actualización se realice correctamente.

+
Los discos de las bandejas conectadas a los puertos Ethernet se informan en `sysconfig -v` la salida.

+
Consulte la link:https://hwu.netapp.com["Hardware Universe de NetApp"^] para obtener información acerca de los puertos de almacenamiento para el sistema a.

.. Compruebe que `storage` el modo está definido y confirme que los puertos están en estado en línea:
+
`storage port show`



. Detenga el nodo: `halt`
+
El nodo debe detenerse en la `LOADER>` prompt.

. En cada nodo, compruebe la fecha, la hora y la zona horaria del sistema: `show date`
. Si es necesario, establezca la fecha en UTC o GMT: `set date <mm/dd/yyyy>`
. Compruebe la hora utilizando el siguiente comando en el símbolo del sistema del entorno de arranque: `show time`
. Si es necesario, establezca la hora en UTC o GMT: `set time <hh:mm:ss>`
. Guarde los ajustes: `saveenv`
. Recopile variables de entorno: `printenv`




=== Actualice los RFC del switch para acomodar las nuevas plataformas

Debe actualizar los switches a una configuración que admita los nuevos modelos de plataforma.

.Acerca de esta tarea
Esta tarea debe realizarse en el sitio que contiene las controladoras que se están actualizando. En los ejemplos que se muestran en este procedimiento, vamos a actualizar SITE_B primero.

Los switches de Site_A se actualizarán cuando se actualicen las controladoras de Site_A.

.Pasos
. Prepare los switches IP para la aplicación de los nuevos archivos RCF.
+
Siga los pasos del procedimiento para su proveedor de switches:

+
link:../install-ip/concept_considerations_differences.html["Instalación y configuración de IP de MetroCluster"]

+
** link:../install-ip/task_switch_config_broadcom.html#resetting-the-broadcom-ip-switch-to-factory-defaults["[Restablezca el conmutador IP Broadcom a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_cisco.html#resetting-the-cisco-ip-switch-to-factory-defaults["Restablezca el conmutador IP de Cisco a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_nvidia.html#reset-the-nvidia-ip-sn2100-switch-to-factory-defaults["Restablece el switch NVIDIA IP SN2100 a los valores predeterminados de fábrica"]


. Descargue e instale los archivos RCF.
+
Siga los pasos de la sección para su proveedor de switches:

+
** link:../install-ip/task_switch_config_broadcom.html#downloading-and-installing-the-broadcom-rcf-files["Descargue e instale los archivos Broadcom RCF"]
** link:../install-ip/task_switch_config_cisco.html#downloading-and-installing-the-cisco-ip-rcf-files["Descargue e instale los archivos Cisco IP RCF"]
** link:../install-ip/task_switch_config_nvidia.html#download-and-install-the-nvidia-rcf-files["Descargue e instale los archivos RCF del conmutador NVIDIA IP SN2100"]






=== Establezca las variables bootarg de MetroCluster IP

Ciertos valores de arranque IP de MetroCluster deben configurarse en los nuevos módulos de la controladora. Los valores deben coincidir con los configurados en los módulos de la controladora anteriores.

.Acerca de esta tarea
* Necesita los UUID y los ID del sistema identificados anteriormente en el procedimiento de actualización en <<gather_info_so_sb,Recopile información antes de la actualización>>.
* Según el modelo de la plataforma, puede especificar el identificador de VLAN mediante el `-vlan-id` parámetro. Las siguientes plataformas no admiten `-vlan-id` el parámetro:
+
** FAS8200 y AFF A300
** AFF A320
** FAS9000 y AFF A700
** AFF C800, ASA C800, AFF A800 y ASA A800
+
Todas las demás plataformas admiten `-vlan-id` el parámetro.



* Los valores de arranque de MetroCluster que establezca dependen de si su nuevo sistema utiliza puertos de clúster/alta disponibilidad compartidos o puertos MetroCluster/alta disponibilidad compartidos.
+
Los sistemas enumerados en la siguiente tabla utilizan *puertos MetroCluster/HA compartidos*.

+
Todos los demás sistemas utilizan *cluster compartido/puertos HA*.

+
[cols="2*"]
|===
| Sistemas AFF y ASA que utilizan puertos MetroCluster/HA compartidos | Sistemas FAS que utilizan puertos compartidos MetroCluster/HA 


 a| 
** AFF A150, ASA A150
** AFF A220
** AFF C250, ASA C250
** AFF A250, ASA A250
** AFF A300
** AFF A320
** AFF C400, ASA C400
** AFF A400, ASA A400
** A700 de AFF
** AFF C800, ASA C800
** AFF A800, ASA A800
** AFF A900, ASA A900

 a| 
** FAS2750
** FAS500f
** FAS8200
** FAS8300
** FAS8700
** FAS9000
** FAS9500


|===


.Pasos
. En la `LOADER>` Prompt, establezca los siguientes bootargs en los nuevos nodos en el site_B:
+
Los pasos que siga dependerán de los puertos que utilice el nuevo modelo de plataforma.

+
[role="tabbed-block"]
====
.Sistemas que utilizan puertos compartidos clúster/alta disponibilidad
--
.. Defina los siguientes arranques:
+
`setenv bootarg.mcc.port_a_ip_config <local-IP-address/local-IP-mask,0,0,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+
`setenv bootarg.mcc.port_b_ip_config <local-IP-address/local-IP-mask,0,0,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+

NOTE: Si las interfaces están usando un ID de VLAN predeterminado, el `vlan-id` parámetro no es necesario.

+
En el siguiente ejemplo se configuran los valores de node_B_1-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.10/23,0,0,172.17.26.13,172.17.26.12,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.10/23,0,0,172.17.27.13,172.17.27.12,130
----
+
En el siguiente ejemplo se configuran los valores de node_B_2-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.11/23,0,0,172.17.26.12,172.17.26.13,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.11/23,0,0,172.17.27.12,172.17.27.13,130
----
+
En el ejemplo siguiente se establecen los valores de node_B_1-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.10/23,0,0,172.17.26.13,172.17.26.12
setenv bootarg.mcc.port_b_ip_config
172.17.27.10/23,0,0,172.17.27.13,172.17.27.12
----
+
En el ejemplo siguiente se establecen los valores de node_B_2-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.11/23,0,0,172.17.26.12,172.17.26.13
setenv bootarg.mcc.port_b_ip_config
172.17.27.11/23,0,0,172.17.27.12,172.17.27.13
----


--
.Sistemas que utilizan puertos compartidos MetroCluster/HA
.. Defina los siguientes arranques:
+
`setenv bootarg.mcc.port_a_ip_config <local-IP-address/local-IP-mask,0,HA-partner-IP-address,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+
`setenv bootarg.mcc.port_b_ip_config <local-IP-address/local-IP-mask,0,HA-partner-IP-address,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+

NOTE: Si las interfaces están usando un ID de VLAN predeterminado, el `vlan-id` parámetro no es necesario.

+
En el siguiente ejemplo se configuran los valores de node_B_1-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.10/23,0,172.17.26.11,172.17.26.13,172.17.26.12,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.10/23,0,172.17.27.11,172.17.27.13,172.17.27.12,130
----
+
En el siguiente ejemplo se configuran los valores de node_B_2-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.11/23,0,172.17.26.10,172.17.26.12,172.17.26.13,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.11/23,0,172.17.27.10,172.17.27.12,172.17.27.13,130
----
+
En el ejemplo siguiente se establecen los valores de node_B_1-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.10/23,0,172.17.26.11,172.17.26.13,172.17.26.12
setenv bootarg.mcc.port_b_ip_config
172.17.27.10/23,0,172.17.27.11,172.17.27.13,172.17.27.12
----
+
En el ejemplo siguiente se establecen los valores de node_B_2-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.11/23,0,172.17.26.10,172.17.26.12,172.17.26.13
setenv bootarg.mcc.port_b_ip_config
172.17.27.11/23,0,172.17.27.10,172.17.27.12,172.17.27.13
----


--

--
====
. En el símbolo del sistema DEL CARGADOR de nodos nuevos, establezca los UUID:
+
`setenv bootarg.mgwd.partner_cluster_uuid <partner-cluster-UUID>`

+
`setenv bootarg.mgwd.cluster_uuid <local-cluster-UUID>`

+
`setenv bootarg.mcc.pri_partner_uuid <DR-partner-node-UUID>`

+
`setenv bootarg.mcc.aux_partner_uuid <DR-aux-partner-node-UUID>`

+
`setenv bootarg.mcc_iscsi.node_uuid <local-node-UUID>`

+
.. Establezca los UUID en node_B_1-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los UUID en node_B_1-new:

+
[listing]
----
setenv bootarg.mgwd.cluster_uuid ee7db9d5-9a82-11e7-b68b-00a098908039
setenv bootarg.mgwd.partner_cluster_uuid 07958819-9ac6-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.pri_partner_uuid f37b240b-9ac1-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.aux_partner_uuid bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f
setenv bootarg.mcc_iscsi.node_uuid f03cb63c-9a7e-11e7-b68b-00a098908039
----
.. Establezca los UUID en node_B_2-new:
+
En el ejemplo siguiente se muestran los comandos para configurar los UUID en node_B_2-new:

+
[listing]
----
setenv bootarg.mgwd.cluster_uuid ee7db9d5-9a82-11e7-b68b-00a098908039
setenv bootarg.mgwd.partner_cluster_uuid 07958819-9ac6-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.pri_partner_uuid bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f
setenv bootarg.mcc.aux_partner_uuid f37b240b-9ac1-11e7-9b42-00a098c9e55d
setenv bootarg.mcc_iscsi.node_uuid aa9a7a7a-9a81-11e7-a4e9-00a098908c35
----


. Determine si los sistemas originales se configuraron para la partición avanzada de unidades (ADP) ejecutando el siguiente comando desde el sitio que está activo:
+
`disk show`

+
La columna de tipo de contenedor muestra “compartido” en la `disk show` salida si ADP está configurado. Si el tipo de contenedor tiene otro valor, ADP no está configurado en el sistema. La siguiente salida de ejemplo muestra un sistema configurado con ADP:

+
[listing]
----
::> disk show
                    Usable               Disk    Container   Container
Disk                Size       Shelf Bay Type    Type        Name      Owner

Info: This cluster has partitioned disks. To get a complete list of spare disk
      capacity use "storage aggregate show-spare-disks".
----------------    ---------- ----- --- ------- ----------- --------- --------
1.11.0              894.0GB    11    0   SSD      shared     testaggr  node_A_1
1.11.1              894.0GB    11    1   SSD      shared     testaggr  node_A_1
1.11.2              894.0GB    11    2   SSD      shared     testaggr  node_A_1
----
. Si los sistemas originales se configuraron con discos particionados para ADP, actívelos en `LOADER` el mensaje de cada nodo de reemplazo:
+
`setenv bootarg.mcc.adp_enabled true`

. Configure las siguientes variables:
+
`setenv bootarg.mcc.local_config_id <original-sys-id>`

+
`setenv bootarg.mcc.dr_partner <dr-partner-sys-id>`

+

NOTE: La `setenv bootarg.mcc.local_config_id` La variable se debe establecer en sys-id del módulo de controlador *original*, node_B_1-old.

+
.. Establezca las variables en node_B_1-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los valores en node_B_1-new:

+
[listing]
----
setenv bootarg.mcc.local_config_id 537403322
setenv bootarg.mcc.dr_partner 537403324
----
.. Establezca las variables en node_B_2-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los valores en node_B_2-new:

+
[listing]
----
setenv bootarg.mcc.local_config_id 537403321
setenv bootarg.mcc.dr_partner 537403323
----


. Si utiliza cifrado con gestor de claves externo, defina los bootargs necesarios:
+
`setenv bootarg.kmip.init.ipaddr`

+
`setenv bootarg.kmip.kmip.init.netmask`

+
`setenv bootarg.kmip.kmip.init.gateway`

+
`setenv bootarg.kmip.kmip.init.interface`





=== Reasignar discos de agregado raíz

Reasigne los discos del agregado raíz al nuevo módulo de la controladora mediante los sides recogidos anteriormente.

.Acerca de esta tarea
Estos pasos se realizan en modo de mantenimiento.


NOTE: Los discos de agregado raíz son los únicos discos que se deben volver a asignar durante el proceso de actualización de la controladora. La propiedad de disco de los agregados de datos se trata como parte de la operación de conmutación de sitios/conmutación de estado.

.Pasos
. Arranque el sistema en modo de mantenimiento:
+
`boot_ontap maint`

. Muestre los discos en node_B_1-new en la indicación Maintenance mode:
+
`disk show -a`

+

CAUTION: Antes de continuar con la reasignación de discos, debe comprobar que la salida de los discos pool0 y pool1 que pertenecen al agregado raíz del nodo se muestren `disk show` . En el ejemplo siguiente, la salida enumera los discos pool0 y pool1 que son propiedad de node_B_1-old.

+
El resultado del comando muestra el ID del sistema del nuevo módulo de la controladora (1574774970). Sin embargo, los discos del agregado raíz siguen siendo propiedad del ID de sistema anterior (537403322). En este ejemplo, no se muestran las unidades que pertenecen a otros nodos en la configuración MetroCluster.

+
[listing]
----
*> disk show -a
Local System ID: 1574774970
DISK                  OWNER                 POOL   SERIAL NUMBER   HOME                  DR HOME
------------          ---------             -----  -------------   -------------         -------------
prod3-rk18:9.126L44   node_B_1-old(537403322)  Pool1  PZHYN0MD     node_B_1-old(537403322)  node_B_1-old(537403322)
prod4-rk18:9.126L49   node_B_1-old(537403322)  Pool1  PPG3J5HA     node_B_1-old(537403322)  node_B_1-old(537403322)
prod4-rk18:8.126L21   node_B_1-old(537403322)  Pool1  PZHTDSZD     node_B_1-old(537403322)  node_B_1-old(537403322)
prod2-rk18:8.126L2    node_B_1-old(537403322)  Pool0  S0M1J2CF     node_B_1-old(537403322)  node_B_1-old(537403322)
prod2-rk18:8.126L3    node_B_1-old(537403322)  Pool0  S0M0CQM5     node_B_1-old(537403322)  node_B_1-old(537403322)
prod1-rk18:9.126L27   node_B_1-old(537403322)  Pool0  S0M1PSDW     node_B_1-old(537403322)  node_B_1-old(537403322)
.
.
.
----
. Reasigne los discos de agregado raíz en las bandejas de unidades a las nuevas controladoras.
+
|===


| Si está utilizando ADP... | A continuación, se usa este comando... 


 a| 
Sí
 a| 
`disk reassign -s <old-sysid> -d <new-sysid> -r <dr-partner-sysid>`



 a| 
No
 a| 
`disk reassign -s <old-sysid> -d <new-sysid>`

|===
. Reasigne los discos de agregado raíz de las bandejas de unidades a las nuevas controladoras:
+
`disk reassign -s <old-sysid> -d <new-sysid>`

+
En el siguiente ejemplo, se muestra la reasignación de unidades en una configuración que no sea de ADP:

+
[listing]
----
*> disk reassign -s 537403322 -d 1574774970
Partner node must not be in Takeover mode during disk reassignment from maintenance mode.
Serious problems could result!!
Do not proceed with reassignment if the partner is in takeover mode. Abort reassignment (y/n)? n

After the node becomes operational, you must perform a takeover and giveback of the HA partner node to ensure disk reassignment is successful.
Do you want to continue (y/n)? y
Disk ownership will be updated on all disks previously belonging to Filer with sysid 537403322.
Do you want to continue (y/n)? y
----
. Compruebe que los discos del agregado raíz se han reasignado correctamente a la eliminación anterior:
+
`disk show`

+
`storage aggr status`

+
[listing]
----

*> disk show
Local System ID: 537097247

  DISK                    OWNER                    POOL   SERIAL NUMBER   HOME                     DR HOME
------------              -------------            -----  -------------   -------------            -------------
prod03-rk18:8.126L18 node_B_1-new(537097247)  Pool1  PZHYN0MD        node_B_1-new(537097247)   node_B_1-new(537097247)
prod04-rk18:9.126L49 node_B_1-new(537097247)  Pool1  PPG3J5HA        node_B_1-new(537097247)   node_B_1-new(537097247)
prod04-rk18:8.126L21 node_B_1-new(537097247)  Pool1  PZHTDSZD        node_B_1-new(537097247)   node_B_1-new(537097247)
prod02-rk18:8.126L2  node_B_1-new(537097247)  Pool0  S0M1J2CF        node_B_1-new(537097247)   node_B_1-new(537097247)
prod02-rk18:9.126L29 node_B_1-new(537097247)  Pool0  S0M0CQM5        node_B_1-new(537097247)   node_B_1-new(537097247)
prod01-rk18:8.126L1  node_B_1-new(537097247)  Pool0  S0M1PSDW        node_B_1-new(537097247)   node_B_1-new(537097247)
::>
::> aggr status
           Aggr          State           Status                Options
aggr0_node_B_1           online          raid_dp, aggr         root, nosnap=on,
                                         mirrored              mirror_resync_priority=high(fixed)
                                         fast zeroed
                                         64-bit
----




=== Arranque las nuevas controladoras

Debe arrancar los nuevos controladores, teniendo cuidado de asegurarse de que las variables bootarg son correctas y, si es necesario, llevar a cabo los pasos de recuperación de cifrado.

.Pasos
. Detenga los nuevos nodos:
+
`halt`

. Si se configura el gestor de claves externo, defina los bootargs relacionados:
+
`setenv bootarg.kmip.init.ipaddr <ip-address>`

+
`setenv bootarg.kmip.init.netmask <netmask>`

+
`setenv bootarg.kmip.init.gateway <gateway-addres>`

+
`setenv bootarg.kmip.init.interface <interface-id>`

. Compruebe si la sísid del compañero es la actual:
+
`printenv partner-sysid`

+
Si el sid del socio no es correcto, configúrelo:

+
`setenv partner-sysid <partner-sysID>`

. Abra el menú de inicio de ONTAP:
+
`boot_ontap menu`

. Si se utiliza el cifrado de raíz, seleccione la opción de menú de inicio para la configuración de administración de claves.
+
|===


| Si está usando... | Seleccione esta opción del menú de inicio... 


 a| 
Gestión de claves incorporada
 a| 
Opción `10`

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.



 a| 
Gestión de claves externas
 a| 
Opción `11`

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.

|===
. En el menú de inicio, seleccione "'(6) Actualizar flash desde backup config'".
+

NOTE: La opción 6 reiniciará el nodo dos veces antes de que finalice.

+
Responda «'y'» a los mensajes de cambio de ID del sistema. Espere a que aparezcan los segundos mensajes de reinicio:

+
[listing]
----
Successfully restored env file from boot media...

Rebooting to load the restored env file...
----
. En LOADER, compruebe dos veces los valores bootarg y actualice los valores según sea necesario.
+
Utilice los pasos de link:task_upgrade_controllers_in_a_four_node_ip_mcc_us_switchover_and_switchback_mcc_ip.html["Configuración de las variables bootarg IP de MetroCluster"].

. Compruebe que la sísid del compañero es la correcta:
+
`printenv partner-sysid`

+
Si el sid del socio no es correcto, configúrelo:

+
`setenv partner-sysid <partner-sysID>`

. Si se utiliza el cifrado de raíz, seleccione de nuevo la opción de menú de inicio para la configuración de administración de claves.
+
|===


| Si está usando... | Seleccione esta opción del menú de inicio... 


 a| 
Gestión de claves incorporada
 a| 
Opción `10`

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.



 a| 
Gestión de claves externas
 a| 
Opción «'11»

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.

|===
+
En función del ajuste del gestor de claves, realice el procedimiento de recuperación seleccionando la opción «'10'» o la opción «'11'», seguida de la opción `6` en el primer símbolo del sistema del menú de inicio. Para arrancar los nodos por completo, puede que necesite repetir el procedimiento de recuperación seguido de la opción «'1'» (arranque normal).

. Espere a que los nodos sustituidos se inicien.
+
Si alguno de los nodos está en modo de toma de control, realice una devolución mediante el `storage failover giveback` comando.

. Si se utiliza el cifrado, restaure las claves con el comando correcto para la configuración de gestión de claves.
+
|===


| Si está usando... | Se usa este comando... 


 a| 
Gestión de claves incorporada
 a| 
`security key-manager onboard sync`

Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-E4AB2ED4-9227-4974-A311-13036EB43A3D.html["Restauración de las claves de cifrado de gestión de claves incorporadas"].



 a| 
Gestión de claves externas
 a| 
`security key-manager external restore -vserver <SVM> -node <node> -key-server <host_name|IP_address:port> -key-id key_id -key-tag key_tag <node_name>`

Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-32DA96C3-9B04-4401-92B8-EAF323C3C863.html["Restauración de claves de cifrado de gestión de claves externas"].

|===
. Verifique que todos los puertos estén en un dominio de retransmisión:
+
.. Vea los dominios de retransmisión:
+
`network port broadcast-domain show`

.. Si se crea un nuevo dominio de retransmisión para los puertos de datos en las controladoras recién actualizadas, elimine el dominio de retransmisión:
+

NOTE: Elimine sólo el nuevo dominio de difusión. No elimine ninguno de los dominios de difusión que existían antes de iniciar la actualización.

+
`broadcast-domain delete -broadcast-domain <broadcast_domain_name>`

.. Añada cualquier puerto a un dominio de retransmisión según sea necesario.
+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-003BDFCD-58A3-46C9-BF0C-BA1D1D1475F9.html["Agregar o quitar puertos de un dominio de retransmisión"]

.. Vuelva a crear las VLAN y los grupos de interfaces según sea necesario.
+
La pertenencia a la VLAN y al grupo de interfaces puede ser diferente de la del nodo antiguo.

+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-8929FCE2-5888-4051-B8C0-E27CAF3F2A63.html["Creación de una VLAN"]

+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-DBC9DEE2-EAB7-430A-A773-4E3420EE2AA1.html["Combinación de puertos físicos para crear grupos de interfaces"]







=== Verifique y restaure la configuración de LIF

Confirmar que las LIF se alojan en los nodos y puertos adecuados, según lo asignado al principio del procedimiento de actualización.

.Acerca de esta tarea
* Esta tarea se realiza en el sitio_B.
* Consulte el plan de asignación de puertos que ha creado en link:task_upgrade_controllers_in_a_four_node_ip_mcc_us_switchover_and_switchback_mcc_ip.html["Asignando los puertos de los nodos antiguos a los nodos nuevos"].



CAUTION: Debe verificar que la ubicación de las LIF de datos sea correcta en los nodos nuevos antes de volver a cambiar. Cuando conmuta la configuración, ONTAP intenta reanudar el tráfico en el puerto de inicio que utilizan las LIF. Se puede producir un fallo de E/S cuando la conexión del puerto de inicio al puerto del switch y la VLAN es incorrecta.

.Pasos
. Compruebe que las LIF están alojadas en el nodo y los puertos adecuados antes de volver a cambiar.
+
.. Cambie al nivel de privilegio avanzado:
+
`set -privilege advanced`

.. Muestre las LIF y confirme que cada LIF de datos está utilizando el puerto de inicio correcto:
+
`network interface show`

.. Modifique los LIF que no estén utilizando el puerto raíz correcto:
+
`network interface modify -vserver <svm-name> -lif <data-lif> -home-port <port-id>`

+
Si el comando devuelve un error, puede anular la configuración del puerto:

+
`vserver config override -command "network interface modify -vserver <svm-name> -home-port <active_port_after_upgrade> -lif <lif_name> -home-node <new_node_name>"`

+
Al introducir el comando de modificación de la interfaz de red dentro del `vserver config override` no se puede utilizar la función de tabulación automática. Puede crear la red `interface modify` con la opción de autocompletar y, a continuación, escríbala en la `vserver config override` comando.

.. Confirme que todas las LIF de datos se encuentran ahora en el puerto de inicio correcto:
+
`network interface show`

.. Vuelva al nivel de privilegio de administrador:
+
`set -privilege admin`



. Revierte las interfaces a su nodo de inicio:
+
`network interface revert * -vserver <svm-name>`

+
Realice este paso en todas las SVM según sea necesario.





== Vuelva a cambiar la configuración de MetroCluster

En esta tarea, podrá llevar a cabo la operación de conmutación de estado, y la configuración de MetroCluster volverá al funcionamiento normal. Los nodos en site_A siguen esperando una actualización.

image::../media/mcc_upgrade_cluster_a_switchback.png[mcc actualiza el clúster a una regreso]

.Pasos
. Emita el `metrocluster node show` Comando en site_B y compruebe la salida.
+
.. Compruebe que los nodos nuevos se representen correctamente.
.. Verifique que los nuevos nodos estén en "esperando el estado de conmutación de estado".


. Lleve a cabo la reparación y la conmutación de estado; para ello, ejecute los comandos necesarios desde cualquier nodo del clúster activo (el clúster no está sometido a actualización).
+
.. Reparar los agregados de datos: +
`metrocluster heal aggregates`
.. Reparar los agregados raíz:
+
`metrocluster heal root`

.. Regreso al clúster:
+
`metrocluster switchback`



. Compruebe el progreso de la operación de regreso:
+
`metrocluster show`

+
La operación de conmutación de estado aún está en curso cuando se muestra el resultado `waiting-for-switchback`:

+
[listing]
----
cluster_B::> metrocluster show
Cluster                   Entry Name          State
------------------------- ------------------- -----------
 Local: cluster_B         Configuration state configured
                          Mode                switchover
                          AUSO Failure Domain -
Remote: cluster_A         Configuration state configured
                          Mode                waiting-for-switchback
                          AUSO Failure Domain -
----
+
La operación de conmutación de estado se completa cuando el resultado muestra normal:

+
[listing]
----
cluster_B::> metrocluster show
Cluster                   Entry Name          State
------------------------- ------------------- -----------
 Local: cluster_B         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain -
Remote: cluster_A         Configuration state configured
                          Mode                normal
                          AUSO Failure Domain -
----
+
Si una conmutación de regreso tarda mucho tiempo en terminar, puede comprobar el estado de las líneas base en curso utilizando el `metrocluster config-replication resync-status show` comando. Este comando se encuentra en el nivel de privilegio avanzado.





== Compruebe el estado de la configuración de MetroCluster

Después de actualizar los módulos de controladora, debe verificar el estado de la configuración de MetroCluster.

.Acerca de esta tarea
Esta tarea se puede realizar en cualquier nodo de la configuración de MetroCluster.

.Pasos
. Compruebe el funcionamiento de la configuración de MetroCluster:
+
.. Confirme la configuración del MetroCluster y que el modo operativo es normal: +
`metrocluster show`
.. Realice una comprobación de MetroCluster: +
`metrocluster check run`
.. Mostrar los resultados de la comprobación de MetroCluster:
+
`metrocluster check show`



. Compruebe el estado y la conectividad de MetroCluster.
+
.. Compruebe las conexiones IP de MetroCluster:
+
`storage iscsi-initiator show`

.. Compruebe que los nodos están funcionando:
+
`metrocluster node show`

.. Compruebe que las interfaces IP de MetroCluster estén en funcionamiento:
+
`metrocluster configuration-settings interface show`

.. Compruebe que la conmutación por error local está activada:
+
`storage failover show`







== Actualice los nodos en cluster_A

Debe repetir las tareas de actualización en cluster_A.

.Pasos
. Repita los pasos para actualizar los nodos en cluster_A, empezando por link:task_upgrade_controllers_in_a_four_node_ip_mcc_us_switchover_and_switchback_mcc_ip.html["Preparando la actualización"].
+
Al realizar las tareas, se revierten todas las referencias de ejemplo a los clústeres y los nodos. Por ejemplo, cuando se dé el ejemplo para cambiar de cluster_A, se cambiará de cluster_B.





== Restaure la supervisión de tiebreaker o de Mediator

Después de completar la actualización de la configuración de MetroCluster, puede reanudar la supervisión con tiebreaker o la utilidad Mediator.

.Pasos
. Restaure la supervisión si es necesario, siguiendo el procedimiento para su configuración.
+
|===
| Si está usando... | Utilice este procedimiento 


 a| 
Tiebreaker
 a| 
link:../tiebreaker/concept_configuring_the_tiebreaker_software.html#adding-metrocluster-configurations["Adición de configuraciones de MetroCluster"].



 a| 
Mediador
 a| 
link:../install-ip/concept_mediator_requirements.html["Configuración del servicio Mediador ONTAP desde una configuración IP de MetroCluster"].



 a| 
Aplicaciones de terceros
 a| 
Consulte la documentación del producto.

|===




== Envíe un mensaje personalizado de AutoSupport tras el mantenimiento

Después de completar la actualización, debe enviar un mensaje de AutoSupport que indique el fin del mantenimiento para que se pueda reanudar la creación automática de casos.

.Pasos
. Para reanudar la generación automática de casos de soporte, envíe un mensaje de AutoSupport para indicar que se ha completado el mantenimiento.
+
.. Emita el siguiente comando: +
`system node autosupport invoke -node * -type all -message MAINT=end`
.. Repita el comando en el clúster de partners.






== Configurar el cifrado integral

Si es compatible con su sistema, puede cifrar el tráfico de back-end, como NVlog y los datos de replicación de almacenamiento, entre los sitios IP de MetroCluster. Consulte link:../maintain/task-configure-encryption.html["Configurar el cifrado integral"] si quiere más información.
