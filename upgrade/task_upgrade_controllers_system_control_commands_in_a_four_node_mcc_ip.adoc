---
permalink: upgrade/task_upgrade_controllers_system_control_commands_in_a_four_node_mcc_ip.html 
sidebar: sidebar 
keywords: metrocluster, upgrade, controllers, switchover, switchback, ip, configuration, net, boot, root, aggregate, system, commands, mcc 
summary: Esta operación de conmutación de MetroCluster guiada y automatizada se puede usar para realizar una actualización de controladora no disruptiva para una configuración de IP MetroCluster de cuatro nodos. 
---
= Actualizar controladoras en una configuración IP de MetroCluster de cuatro nodos mediante conmutación de sitios y conmutación de estado con comandos de sustitución de controladoras del sistema (ONTAP 9.13.1 y versiones posteriores)
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
Esta operación de conmutación de sitios guiada automatizada de MetroCluster se puede usar para realizar una actualización de controladora no disruptiva en una configuración IP de MetroCluster de cuatro nodos. Como parte de este procedimiento, no se pueden actualizar otros componentes (como bandejas de almacenamiento o switches).



== Actualizaciones de la controladora IP de MetroCluster admitidas mediante comandos de sustitución de la controladora del sistema

Encuentre su plataforma *Source* en las tablas de actualización del controlador MetroCluster en esta sección. Si la intersección de la fila de la plataforma *Source* y la columna de la plataforma *Target* está en blanco, la actualización no es compatible.

Antes de iniciar la actualización, revise las siguientes consideraciones para verificar que la configuración sea compatible.

* Si la plataforma no aparece en la lista, no existe una combinación de actualización de controladoras compatible.
* Cuando se realiza una actualización del controlador, el tipo de plataforma anterior y el nuevo *debe* coincidir:
+
** Puede actualizar un sistema FAS a un sistema FAS o un AFF A-Series a un AFF A-Series.
** No puede actualizar un sistema FAS a un AFF A-Series ni un AFF A-Series a un AFF C-Series.
+
Por ejemplo, si la plataforma que desea actualizar es FAS8200, puede actualizar a la versión FAS9000. No puede actualizar un sistema FAS8200 a un sistema AFF A700.



* Todos los nodos (antiguos y nuevos) de la configuración de MetroCluster deben ejecutar la misma versión de ONTAP.


.Actualizaciones de controladoras IP de AFF y FAS MetroCluster admitidas
La siguiente tabla muestra las combinaciones de plataformas admitidas para actualizar un sistema AFF o FAS en una configuración de IP de MetroCluster utilizando los comandos «system controller replace»:

image::../media/mcc_ip_system_controller_replace_aff_fas.png[el controlador del sistema mcc ip reemplaza a AFF FAS]

* Nota 1: Las actualizaciones de controladoras se admiten en sistemas que ejecutan ONTAP 9.13.1 o posterior.
* Nota 2: La plataforma de destino no puede tener unidades internas hasta que finalice la actualización de la controladora. Es posible añadir las unidades internas después de la actualización.
* Nota 3: Requiere la sustitución de los módulos del controlador.


.Actualizaciones de la controladora IP de ASA MetroCluster admitidas
No se admite la actualización de controladoras mediante `system controller replace` comandos en sistemas ASA.

Consulte link:https://docs.netapp.com/us-en/ontap-metrocluster/upgrade/concept_choosing_an_upgrade_method_mcc.html["Seleccione un método de actualización o actualización"] para procedimientos adicionales.



== Acerca de esta tarea

* Este procedimiento solo se puede usar para actualizar la controladora.
+
Otros componentes de la configuración, como bandejas de almacenamiento o switches, no pueden actualizarse al mismo tiempo.

* Los switches IP de MetroCluster (tipo de switch, proveedor y modelo) y la versión de firmware deben ser compatibles con las controladoras nuevas y existentes en la configuración de actualización.
+
Consulte link:https://hwu.netapp.com["Hardware Universe de NetApp"^] o la link:https://imt.netapp.com/matrix/["IMT"^] para conocer las versiones de firmware y switches compatibles.

* Los sistemas MetroCluster deben ejecutar la misma versión de ONTAP en ambos sitios.
* Puede utilizar este procedimiento para actualizar controladoras en una configuración de IP de MetroCluster de cuatro nodos mediante la conmutación de sitios y la conmutación de estado automatizada basada en NSO.
+

NOTE: La realización de una actualización mediante la reubicación de agregados (ARL) con comandos «systems controller replace» no se admite para una configuración de IP de MetroCluster de cuatro nodos.

* Si está activada en el sistema, link:../maintain/task-configure-encryption.html#disable-end-to-end-encryption["deshabilite el cifrado integral"] antes de realizar la actualización.
* Debe utilizar el procedimiento de actualización automática de la controladora NSO para actualizar las controladoras en ambos sitios en secuencia.
* Este procedimiento automatizado de actualización de controladora basada en la NSO le ofrece la posibilidad de iniciar la sustitución de controladoras a un sitio de recuperación ante desastres (DR) de MetroCluster. Solo puede iniciar el reemplazo de una controladora en una instalación cada vez.
* Para iniciar la sustitución de una controladora en el sitio A, debe ejecutar el comando Controller rereemplazo start desde el sitio B. La operación le guía para reemplazar controladoras de ambos nodos en el sitio A únicamente. Para sustituir las controladoras en el sitio B, debe ejecutar el comando Controller replace start desde el sitio A. Aparece un mensaje que identifica el sitio en el que se van a reemplazar los controladores.


En este procedimiento se utilizan los nombres de ejemplo siguientes:

* Sitio_a
+
** Antes de la actualización:
+
*** Node_a_1-old
*** Node_A_2-old


** Después de la actualización:
+
*** Node_A_1-new
*** Node_A_2-New




* Centro_B
+
** Antes de la actualización:
+
*** Node_B_1-old
*** Node_B_2-old


** Después de la actualización:
+
*** Node_B_1-New
*** Node_B_2-New








== Active el registro de la consola

NetApp recomienda encarecidamente que habilite el inicio de sesión de la consola en los dispositivos que esté utilizando y realice las siguientes acciones al realizar este procedimiento:

* Deje la función AutoSupport habilitada durante el mantenimiento.
* Active un mensaje de AutoSupport de mantenimiento antes y después de las tareas de mantenimiento para deshabilitar la creación de casos durante la actividad de mantenimiento.
+
Consulte el artículo de la base de conocimientos link:https://kb.netapp.com/Support_Bulletins/Customer_Bulletins/SU92["Cómo impedir la creación automática de casos durante las ventanas de mantenimiento programado"^].

* Habilite el registro de sesiones para cualquier sesión de CLI. Para obtener instrucciones sobre cómo activar el registro de sesiones, consulte la sección Salida de sesión de registro en el artículo de la Base de conocimientos link:https://kb.netapp.com/on-prem/ontap/Ontap_OS/OS-KBs/How_to_configure_PuTTY_for_optimal_connectivity_to_ONTAP_systems["Cómo configurar PuTTY para una conectividad óptima con sistemas ONTAP"^].




== Defina el inicio necesario en el sistema existente

Si va a actualizar a un sistema AFF A70, AFF A90 o AFF A1K, siga los pasos para configurar el `hw.cxgbe.toe_keepalive_disable=1` arranque.


CAUTION: Si va a actualizar a un sistema AFF A70, AFF A90 o AFF A1K, * debe * completar esta tarea antes de realizar la actualización. Esta tarea *solamente* se aplica a las actualizaciones a un sistema AFF A70, AFF A90 o AFF A1K desde un sistema compatible. Para todas las demás actualizaciones, puede omitir esta tarea e ir directamente a <<prepare_system_replace_upgrade,Prepare la actualización>>.

.Pasos
. Detenga un nodo en cada sitio y permita que su compañero de alta disponibilidad realice una toma de control de almacenamiento del nodo:
+
`halt  -node <node_name>`

. En `LOADER` el símbolo del sistema del nodo detenido, introduzca lo siguiente:
+
`setenv hw.cxgbe.toe_keepalive_disable 1`

+
`saveenv`

+
`printenv hw.cxgbe.toe_keepalive_disable`

. Arrancar el nodo:
+
`boot_ontap`

. Cuando el nodo arranque, realice un retorno al nodo en el símbolo del sistema:
+
`storage failover giveback -ofnode <node_name>`

. Repita los pasos en cada nodo del grupo de recuperación ante desastres que se esté actualizando.




== Prepare la actualización

Para preparar la actualización de la controladora, debe realizar comprobaciones previas del sistema y recopilar la información de la configuración.

Antes de que se inicien las comprobaciones previas, si se instala ONTAP Mediator, se detecta y elimina automáticamente. Para confirmar la eliminación, se le pedirá que introduzca un nombre de usuario y una contraseña. Cuando completa la actualización, o si las comprobaciones previas fallan o si elige no continuar con la actualización, debe <<man_reconfig_mediator,Reconfigurar manualmente ONTAP Mediator>>.

En cualquier momento durante la actualización, puede ejecutar el `system controller replace show` o. `system controller replace show-details` Comando del sitio A para comprobar el estado. Si los comandos devuelven un resultado en blanco, espere unos minutos y vuelva a ejecutar el comando.

.Pasos
. Inicie el procedimiento de sustitución de controladora automatizado del sitio A para sustituir las controladoras en el sitio B:
+
`system controller replace start -nso true`

+
La operación automatizada ejecuta las comprobaciones previas. Si no se encuentra ningún problema, la operación se coloca en pausa para recopilar manualmente la información relacionada con la configuración.

+
[NOTE]
====
** Si no ejecuta el `system controller replace start -nso true` Comando, el procedimiento de actualización de controladora elige la conmutación de sitios y la conmutación de estado automatizadas basadas en NSO como el procedimiento predeterminado en los sistemas IP de MetroCluster.
** Se muestran el sistema de origen actual y todos los sistemas de destino compatibles. Si sustituyó la controladora de origen con una controladora que tiene una versión de ONTAP diferente o una plataforma no compatible, la operación de automatización se detiene e informa de un error después de que se arrancan los nuevos nodos. Para que el clúster vuelva a estar en buen estado, debe seguir el procedimiento de recuperación manual.
+
La `system controller replace start` el comando puede informar el siguiente error de las comprobaciones previas:

+
[listing]
----
Cluster-A::*>system controller replace show
Node        Status         Error-Action
----------- -------------- ------------------------------------
Node-A-1    Failed         MetroCluster check failed. Reason : MCC check showed errors in component aggregates
----
+
Compruebe si se ha producido este error porque ha reflejado agregados o debido a otro problema de agregado. Verifique que todos los agregados reflejados estén en buen estado y no degradado o con estado de reflejo degradado. Si este error se debe únicamente a agregados no reflejados, puede seleccionar la opción para anular este error `-skip-metrocluster-check true` en la `system controller replace start` comando. Si puede accederse al almacenamiento remoto, los agregados no reflejados entran en línea tras realizar la conmutación. Si el enlace de almacenamiento remoto falla, los agregados no reflejados no pueden conectarse.



====
. Para recopilar manualmente la información de configuración, inicie sesión en el sitio B y siga los comandos enumerados en el mensaje de la consola en `system controller replace show` o. `system controller replace show-details` comando.




=== Recopile información antes de la actualización

Antes de la actualización, si el volumen raíz está cifrado, se debe recopilar la clave de backup y otra información para arrancar las nuevas controladoras con los volúmenes raíz cifrados anteriores.

.Acerca de esta tarea
Esta tarea se lleva a cabo en la configuración de IP de MetroCluster existente.

.Pasos
. Etiquete los cables de las controladoras existentes para que puedan identificar fácilmente los cables cuando configure las nuevas controladoras.
. Muestre los comandos para capturar la clave de backup y otra información:
+
`system controller replace show`

+
Ejecute los comandos enumerados en `show` del clúster de partners.

+
La `show` La salida del comando muestra tres tablas que contienen las direcciones IP de la interfaz de MetroCluster, los ID del sistema y los UUID del sistema. Esta información es necesaria más adelante en el procedimiento para establecer los arranques al iniciar el nuevo nodo.

. Recopile los ID del sistema de los nodos en la configuración de MetroCluster:
+
--
`metrocluster node show -fields node-systemid,dr-partner-systemid`

Durante el procedimiento de actualización, reemplazará estos antiguos ID del sistema por los ID de sistema de los nuevos módulos del controlador.

En este ejemplo, para una configuración de IP de MetroCluster de cuatro nodos, se recuperan los siguientes ID de sistema anteriores:

** Node_A_1-old: 4068741258
** Node_A_2-old: 4068741260
** Node_B_1-old: 4068741254
** Node_B_2-old: 4068741256


[listing]
----
metrocluster-siteA::> metrocluster node show -fields node-systemid,ha-partner-systemid,dr-partner-systemid,dr-auxiliary-systemid
dr-group-id        cluster           node            node-systemid     ha-partner-systemid     dr-partner-systemid    dr-auxiliary-systemid
-----------        ---------------   ----------      -------------     -------------------     -------------------    ---------------------
1                    Cluster_A       Node_A_1-old    4068741258        4068741260              4068741256             4068741256
1                    Cluster_A       Node_A_2-old    4068741260        4068741258              4068741254             4068741254
1                    Cluster_B       Node_B_1-old    4068741254        4068741256              4068741258             4068741260
1                    Cluster_B       Node_B_2-old    4068741256        4068741254              4068741260             4068741258
4 entries were displayed.
----
En este ejemplo, para una configuración de IP de MetroCluster de dos nodos, se recuperan los siguientes ID de sistema antiguos:

** Node_a_1: 4068741258
** Node_B_1: 4068741254


[listing]
----
metrocluster node show -fields node-systemid,dr-partner-systemid

dr-group-id cluster    node          node-systemid dr-partner-systemid
----------- ---------- --------      ------------- ------------
1           Cluster_A  Node_A_1-old  4068741258    4068741254
1           Cluster_B  node_B_1-old  -             -
2 entries were displayed.
----
--
. Recopile información del puerto y LIF para cada nodo antiguo.
+
Debe recopilar el resultado de los siguientes comandos para cada nodo:

+
** `network interface show -role cluster,node-mgmt`
** `network port show -node <node-name> -type physical`
** `network port vlan show -node <node-name>`
** `network port ifgrp show -node <node-name> -instance`
** `network port broadcast-domain show`
** `network port reachability show -detail`
** `network ipspace show`
** `volume show`
** `storage aggregate show`
** `system node run -node <node-name> sysconfig -a`
** `aggr show -r`
** `disk show`
** `system node run <node-name> disk show`
** `vol show -fields type`
** `vol show -fields type , space-guarantee`
** `vserver fcp initiator show`
** `storage disk show`
** `metrocluster configuration-settings interface show`


. Si los nodos MetroCluster tienen una configuración SAN, recopile la información pertinente.
+
Debe recopilar el resultado de los siguientes comandos:

+
** `fcp adapter show -instance`
** `fcp interface show -instance`
** `iscsi interface show`
** `ucadmin show`


. Si el volumen raíz está cifrado, recopile y guarde la clave de acceso usada para Key-Manager:
+
`security key-manager backup show`

. Si los nodos de MetroCluster utilizan el cifrado de volúmenes o agregados, copie información sobre las claves y las Passphrases.
+
Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-1677AE0A-FEF7-45FA-8616-885AA3283BCF.html["Realizar un backup manual de la información de gestión de claves incorporada"^].

+
.. Si se configuró el gestor de claves incorporado:
+
`security key-manager onboard show-backup`

+
Necesitará la contraseña más adelante en el procedimiento de actualización.

.. Si está configurada la gestión de claves empresariales (KMIP), ejecute los siguientes comandos:
+
`security key-manager external show -instance`

+
`security key-manager key query`



. Después de terminar de recoger la información de configuración, reanude la operación:
+
`system controller replace resume`





=== Elimine la configuración existente del tiebreaker o del otro software de supervisión

Si la configuración existente se supervisa con la configuración de tiebreaker para MetroCluster u otras aplicaciones de terceros (por ejemplo, ClusterLion) que pueden iniciar una conmutación de sitios, debe eliminar la configuración de MetroCluster del tiebreaker o de otro software antes de sustituir el controlador antiguo.

.Pasos
. link:../tiebreaker/concept_configuring_the_tiebreaker_software.html#removing-metrocluster-configurations["Quitar la configuración de MetroCluster existente"] Del software Tiebreaker.
. Elimine la configuración de MetroCluster existente de cualquier aplicación de terceros que pueda iniciar la conmutación.
+
Consulte la documentación de la aplicación.





== Sustituya las controladoras antiguas y arranque las nuevas controladoras

Después de recopilar información y reanudar la operación, la automatización avanza con la operación de conmutación.

.Acerca de esta tarea
La operación de automatización inicia las operaciones de conmutación de sitios. Una vez finalizadas estas operaciones, la operación se detiene en *pausa para la intervención del usuario* para que pueda instalar los controladores en rack, iniciar los controladores asociados y reasignar los discos agregados raíz al nuevo módulo del controlador desde la copia de seguridad flash mediante el `sysids` reunidos antes.

.Antes de empezar
Antes de iniciar la conmutación, la operación de automatización se pone en pausa para que pueda comprobar manualmente que todas las LIF están «'más'» en el sitio B. En caso necesario, llevar cualquier LIF «desposeída» a «arriba» y reanudar la operación de automatización utilizando el `system controller replace resume` comando.



=== Prepare la configuración de red de las controladoras antiguas

Para permitir que las redes se reanuden de forma limpia en las nuevas controladoras, debe comprobar que la ubicación del LIF sea correcta y quitar la configuración de redes de las controladoras antiguas.

.Acerca de esta tarea
* Esta tarea se debe realizar en cada uno de los nodos antiguos.
* Usted utilizará la información recopilada en <<prepare_system_replace_upgrade,Prepare la actualización>>.


.Pasos
. Arranque los nodos antiguos y después inicie sesión en los nodos:
+
`boot_ontap`

. Modifique las LIF de interconexión de clústeres de las controladoras antiguas para que usen un puerto raíz diferente a los puertos utilizados para la interconexión de alta disponibilidad o la interconexión de recuperación ante desastres IP de MetroCluster en las nuevas controladoras.
+

NOTE: Este paso es necesario para una actualización correcta.

+
Las LIF de interconexión de clústeres de las controladoras antiguas deben usar un puerto inicial diferente al de los puertos utilizados para la interconexión de alta disponibilidad o la interconexión de recuperación ante desastres IP de MetroCluster en las nuevas controladoras. Por ejemplo, cuando se actualiza a controladoras AFF A90, los puertos de interconexión de alta disponibilidad son e1a y e7a, y los puertos de interconexión de recuperación ante desastres IP de MetroCluster son E2B y E3b. Debe mover las LIF de interconexión de clústeres de las controladoras anteriores si están alojadas en los puertos e1a, e7a, E2B o E3b.

+
Para la distribución y asignación de puertos en los nuevos nodos, consulte la https://hwu.netapp.com["Hardware Universe de NetApp"].

+
.. En las controladoras antiguas, vea las LIF de interconexión de clústeres:
+
`network interface show  -role intercluster`

+
Una de las siguientes acciones dependerá de si las LIF de interconexión de clústeres de las controladoras anteriores usan los mismos puertos que los utilizados para la interconexión de alta disponibilidad o la interconexión MetroCluster IP DR en las nuevas controladoras.

+
[cols="2*"]
|===
| Si las LIF de interconexión de clústeres... | Vaya a... 


| Utilice el mismo puerto de inicio | <<controller_replace_upgrade_prepare_network_ports_2b,Subpaso b>> 


| Utilice un puerto de inicio diferente | <<controller_replace_upgrade_prepare_network_ports_3,Paso 3>> 
|===
.. [[controller_replace_upgrade_prepare_network_ports_2b]]Modifique las LIF de interconexión de clústeres para utilizar un puerto raíz diferente:
+
`network interface modify -vserver <vserver> -lif <intercluster_lif> -home-port <port-not-used-for-ha-interconnect-or-mcc-ip-dr-interconnect-on-new-nodes>`

.. Compruebe que todas las LIF de interconexión de clústeres se encuentran en sus nuevos puertos principales:
+
`network interface show -role intercluster -is-home  false`

+
El resultado del comando debe estar vacío, lo que indica que todas las LIF de interconexión de clústeres están en sus respectivos puertos principales.

.. Si hay algún LIF que no está en sus puertos raíz, revertiéndolo con el siguiente comando:
+
`network interface revert -lif <intercluster_lif>`

+
Repita el comando para cada LIF de interconexión de clústeres que no esté en el puerto de inicio.



. [[controller_replace_upgrade_prepare_network_ports_3]]Asigne el puerto raíz de todas las LIF de datos de la controladora antigua a un puerto común que sea el mismo en los módulos de controladora antiguos y nuevos.
+

CAUTION: Si las controladoras antigua y nueva no disponen de un puerto común, no necesitará modificar las LIF de datos. Sáltese este paso y vaya directamente a <<upgrades_assisted_without_matching_ports,Paso 4>>.

+
.. Mostrar las LIF:
+
`network interface show`

+
Todos los LIF de datos, incluidos SAN y NAS, serán «propios» de administrador y «inactivos» operacionalmente, ya que están en el sitio de la conmutación (cluster_A).

.. Revise el resultado para encontrar un puerto de red física común que sea el mismo en las controladoras anterior y nueva que no se use como puerto de clúster.
+
Por ejemplo, «'e0d» es un puerto físico de las controladoras antiguas y también está presente en las nuevas controladoras. «'e0d'» no se utiliza como puerto de clúster ni de ningún otro modo en las nuevas controladoras.

+
Para el uso de puertos para los modelos de plataforma, consulte link:https://hwu.netapp.com/["Hardware Universe de NetApp"^]

.. Modifique todas las LIF de datos para utilizar el puerto común como puerto de inicio:
+
`network interface modify -vserver <svm-name> -lif <data-lif> -home-port <port-id>`

+
En el siguiente ejemplo, esto es «'e0d'».

+
Por ejemplo:

+
[listing]
----
network interface modify -vserver vs0 -lif datalif1 -home-port e0d
----


. [[upgrades_assisted_without_matching_ports]] Modifique los dominios de difusión para eliminar la VLAN y los puertos físicos que deben eliminarse:
+
`broadcast-domain remove-ports -broadcast-domain <broadcast-domain-name>-ports <node-name:port-id>`

+
Repita este paso para todos los puertos VLAN y físicos.

. Quite todos los puertos VLAN que utilizan puertos de clúster como puertos miembro y grupos de interfaces usando puertos de clúster como puertos miembro.
+
.. Eliminar puertos VLAN:
+
`network port vlan delete -node <node-name> -vlan-name <portid-vlandid>`

+
Por ejemplo:

+
[listing]
----
network port vlan delete -node node1 -vlan-name e1c-80
----
.. Quite puertos físicos de los grupos de interfaces:
+
`network port ifgrp remove-port -node <node-name> -ifgrp <interface-group-name> -port <portid>`

+
Por ejemplo:

+
[listing]
----
network port ifgrp remove-port -node node1 -ifgrp a1a -port e0d
----
.. Quite los puertos VLAN y grupos de interfaces del dominio de retransmisión:
+
`network port broadcast-domain remove-ports -ipspace <ipspace> -broadcast-domain <broadcast-domain-name>-ports <nodename:portname,nodename:portname>,..`

.. Modifique los puertos del grupo de interfaces para utilizar otros puertos físicos como miembro según sea necesario.:
+
`ifgrp add-port -node <node-name> -ifgrp <interface-group-name> -port <port-id>`



. Detenga los nodos:
+
`halt -inhibit-takeover true -node <node-name>`

+
Este paso debe realizarse en ambos nodos.

. Compruebe que los nodos se encuentran en `LOADER` el prompt y recopile y conserve las variables de entorno actuales.
. Recopile los valores bootarg:
+
`printenv`

. Apague los nodos y las bandejas en el sitio donde se está actualizando la controladora.




=== Configure las nuevas controladoras

Debe montar en rack y cablear las nuevas controladoras.

.Pasos
. Planifique la colocación de los nuevos módulos de controladora y bandejas de almacenamiento según sea necesario.
+
El espacio en rack depende del modelo de plataforma de los módulos de la controladora, los tipos de switch y el número de bandejas de almacenamiento de la configuración.

. Puesta a tierra apropiadamente usted mismo.
. Si la actualización requiere reemplazar los módulos de la controladora, por ejemplo, actualizar de un sistema AFF 800 a un sistema AFF A90, debe quitar el módulo de la controladora del chasis cuando sustituya el módulo de la controladora. Para todas las demás actualizaciones, vaya a <<ip_upgrades_replace_4,Paso 4>>.
+
En la parte frontal del chasis, utilice los pulgares para empujar con firmeza cada unidad hasta que sienta una parada positiva. Esto confirma que las unidades están firmemente asentadas contra el plano medio del chasis.

+
image::../media/drw_a800_drive_seated.png[Muestra cómo quitar el módulo de controladora del chasis]

. [[ip_upgrades_replace_4]] Instale los módulos del controlador.
+

NOTE: Los pasos siguientes de instalación dependen de si su actualización requiere la sustitución de los módulos del controlador, como una actualización de un sistema AFF 800 a un sistema AFF A90.

+
[role="tabbed-block"]
====
.Actualizaciones que requieren la sustitución del módulo de la controladora
--
La instalación de las controladoras nuevas no es aplicable en las actualizaciones de sistemas integrados con discos y controladoras en el mismo chasis, por ejemplo, de un sistema AFF A800 a un sistema AFF A90. Los nuevos módulos de controladora y tarjetas I/O se deben intercambiar tras apagar las controladoras antiguas, como se muestra en la imagen siguiente.

La siguiente imagen de ejemplo es solo para representación. Los módulos de la controladora y las tarjetas I/O pueden variar de un sistema a otro.

image::../media/a90_a70_pcm_swap.png[Muestra el intercambio del módulo del controlador]

--
.Todas las demás actualizaciones
--
Instale los módulos de la controladora en el rack o armario.

--
====
. Conecte los cables de alimentación, consola de serie y conexiones de gestión de las controladoras tal como se describe en link:../install-ip/using_rcf_generator.html["Cableado de los switches IP de MetroCluster"]
+
No conecte ningún otro cable que esté desconectado de las controladoras antiguas en este momento.

+
https://docs.netapp.com/us-en/ontap-systems/index.html["Documentación de los sistemas de hardware de ONTAP"^]

. Encienda los nuevos nodos y pulse Ctrl-C cuando se le solicite que muestre `LOADER` el símbolo del sistema de.




=== Arranque por red las nuevas controladoras

Después de instalar los nodos nuevos, debe reiniciar el sistema para asegurarse de que los nuevos nodos estén ejecutando la misma versión de ONTAP que los nodos originales. El término arranque desde red significa que se arranca desde una imagen ONTAP almacenada en un servidor remoto. Al prepararse para reiniciar el sistema, debe colocar una copia de la imagen de arranque ONTAP 9 en un servidor web al que pueda acceder el sistema.

Esta tarea se realiza en cada uno de los nuevos módulos del controlador.

.Pasos
. Acceda a link:https://mysupport.netapp.com/site/["Sitio de soporte de NetApp"^] para descargar los archivos utilizados para realizar el arranque desde red del sistema.
. Descargue el software ONTAP adecuado desde la sección de descarga de software del sitio de soporte de NetApp y almacene el archivo ontap-version_image.tgz en un directorio accesible desde la web.
. Vaya al directorio accesible a Internet y compruebe que los archivos que necesita están disponibles.
+
La lista de directorios debe contener una carpeta netboot con un archivo de núcleo: ontap-version_image.tgz

+
No es necesario extraer el archivo ontap-version_image.tgz.

. En el `LOADER` prompt, configure la conexión netboot para una LIF de gestión:
+
** Si el direccionamiento IP es DHCP, configure la conexión automática:
+
`ifconfig e0M -auto`

** Si el direccionamiento IP es estático, configure la conexión manual:
+
`ifconfig e0M -addr=ip_addr -mask=netmask` `-gw=gateway`



. Reiniciar el sistema.
+
`netboot \http://web_server_ip/path_to_web-accessible_directory/ontap-version_image.tgz`

. En el menú de inicio, seleccione la opción *(7) instale primero el nuevo software* para descargar e instalar la nueva imagen de software en el dispositivo de arranque.
+
 Disregard the following message: "This procedure is not supported for Non-Disruptive Upgrade on an HA pair". It applies to nondisruptive upgrades of software, not to upgrades of controllers.
. Si se le solicita que continúe el procedimiento, introduzca `y`Y cuando se le solicite el paquete, escriba la dirección URL del archivo de imagen: `\http://web_server_ip/path_to_web-accessible_directory/ontap-version_image.tgz`
+
....
Enter username/password if applicable, or press Enter to continue.
....
. No olvide entrar `n` para omitir la recuperación de backup cuando observe un símbolo del sistema similar a lo siguiente:
+
....
Do you want to restore the backup configuration now? {y|n}
....
. Reinicie introduciendo `y` cuando vea un símbolo del sistema similar a lo siguiente:
+
....
The node must be rebooted to start using the newly installed software. Do you want to reboot now? {y|n}
....




=== Borrar la configuración de un módulo de controlador

[role="lead"]
Antes de utilizar un nuevo módulo de controladora en la configuración de MetroCluster, debe borrar la configuración existente.

.Pasos
. Si es necesario, detenga el nodo para mostrar el símbolo del sistema del CARGADOR:
+
`halt`

. En el símbolo del sistema del CARGADOR, establezca las variables de entorno en los valores predeterminados:
+
`set-defaults`

. Guarde el entorno:
+
`saveenv`

. En el símbolo del sistema del CARGADOR, inicie el menú de arranque:
+
`boot_ontap menu`

. En el símbolo del sistema del menú de inicio, borre la configuración:
+
`wipeconfig`

+
Responda `yes` a la solicitud de confirmación.

+
El nodo se reinicia y el menú de arranque se muestra de nuevo.

. En el menú de inicio, seleccione la opción *5* para arrancar el sistema en modo de mantenimiento.
+
Responda `yes` a la solicitud de confirmación.





=== Restaure la configuración de HBA

Dependiendo de la presencia y configuración de tarjetas HBA en el módulo de controlador, debe configurarlas correctamente para el uso de su sitio.

.Pasos
. En el modo de mantenimiento configure los ajustes para cualquier HBA del sistema:
+
.. Compruebe la configuración actual de los puertos: `ucadmin show`
.. Actualice la configuración del puerto según sea necesario.


+
|===


| Si tiene este tipo de HBA y el modo que desea... | Se usa este comando... 


 a| 
CNA FC
 a| 
`ucadmin modify -m fc -t initiator <adapter-name>`



 a| 
Ethernet de CNA
 a| 
`ucadmin modify -mode cna <adapter-name>`



 a| 
Destino FC
 a| 
`fcadmin config -t target <adapter-name>`



 a| 
Iniciador FC
 a| 
`fcadmin config -t initiator <adapter-name>`

|===
. Salir del modo de mantenimiento:
+
`halt`

+
Tras ejecutar el comando, espere hasta que el nodo se detenga en `LOADER` el símbolo del sistema de.

. Vuelva a arrancar el nodo en modo de mantenimiento para permitir que los cambios de configuración surtan efecto:
+
`boot_ontap maint`

. Compruebe los cambios realizados:
+
|===


| Si tiene este tipo de HBA... | Se usa este comando... 


 a| 
CNA
 a| 
`ucadmin show`



 a| 
FC
 a| 
`fcadmin show`

|===




=== Establezca el estado de alta disponibilidad en las controladoras y el chasis nuevos

Debe comprobar el estado de alta disponibilidad de las controladoras y el chasis y, si es necesario, actualizar el estado para que coincida con la configuración del sistema.

.Pasos
. En el modo de mantenimiento, muestre el estado de alta disponibilidad del módulo de controladora y el chasis:
+
`ha-config show`

+
El estado de alta disponibilidad para todos los componentes debe ser `mccip`.

. Si el estado del sistema mostrado de la controladora o el chasis no es correcto, establezca el estado de alta disponibilidad:
+
`ha-config modify controller mccip`

+
`ha-config modify chassis mccip`

. Verifique y modifique los puertos Ethernet conectados a bandejas NS224 o switches de almacenamiento.
+
.. Compruebe los puertos Ethernet conectados a las bandejas NS224 o los switches de almacenamiento:
+
`storage port show`

.. Establezca todos los puertos Ethernet conectados a bandejas Ethernet o switches de almacenamiento, incluidos los switches compartidos para almacenamiento y clúster, en `storage` modo:
+
`storage port modify -p <port> -m storage`

+
Ejemplo:

+
[listing]
----
*> storage port modify -p e5b -m storage
Changing NVMe-oF port e5b to storage mode
----
+

NOTE: Esto debe establecerse en todos los puertos afectados para que la actualización se realice correctamente.

+
Los discos de las bandejas conectadas a los puertos Ethernet se informan en `sysconfig -v` la salida.

+
Consulte la link:https://hwu.netapp.com["Hardware Universe de NetApp"^] para obtener información acerca de los puertos de almacenamiento para el sistema a.

.. Compruebe que `storage` el modo está definido y confirme que los puertos están en estado en línea:
+
`storage port show`



. Detenga el nodo: `halt`
+
El nodo debe detenerse en la `LOADER>` prompt.

. En cada nodo, compruebe la fecha, la hora y la zona horaria del sistema: `show date`
. Si es necesario, establezca la fecha en UTC o GMT: `set date <mm/dd/yyyy>`
. Compruebe la hora utilizando el siguiente comando en el símbolo del sistema del entorno de arranque: `show time`
. Si es necesario, establezca la hora en UTC o GMT: `set time <hh:mm:ss>`
. Guarde los ajustes: `saveenv`
. Recopile variables de entorno: `printenv`




=== Actualice los archivos RCF del switch para acomodar las nuevas plataformas

Debe actualizar los switches a una configuración que admita los nuevos modelos de plataforma.

.Acerca de esta tarea
Esta tarea debe realizarse en el sitio que contiene las controladoras que se están actualizando. En los ejemplos mostrados en este procedimiento, estamos actualizando site_B primero.

Los switches de Site_A se actualizarán cuando se actualicen las controladoras de Site_A.

.Pasos
. Prepare los switches IP para la aplicación de los nuevos archivos RCF.
+
Siga los pasos de la sección para su proveedor de switches:

+
** link:../install-ip/task_switch_config_broadcom.html#resetting-the-broadcom-ip-switch-to-factory-defaults["Restablezca el conmutador IP Broadcom a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_cisco.html#resetting-the-cisco-ip-switch-to-factory-defaults["Restablezca el conmutador IP de Cisco a los valores predeterminados de fábrica"]
** link:../install-ip/task_switch_config_nvidia.html#reset-the-nvidia-ip-sn2100-switch-to-factory-defaults["Restablece el switch NVIDIA IP SN2100 a los valores predeterminados de fábrica"]


. Descargue e instale los archivos RCF.
+
Siga los pasos de la sección para su proveedor de switches:

+
** link:../install-ip/task_switch_config_broadcom.html#downloading-and-installing-the-broadcom-rcf-files["Descargue e instale los archivos Broadcom RCF"]
** link:../install-ip/task_switch_config_cisco.html#downloading-and-installing-the-cisco-ip-rcf-files["Descargue e instale los archivos Cisco IP RCF"]
** link:../install-ip/task_switch_config_nvidia.html#download-and-install-the-nvidia-rcf-files["Descargue e instale los archivos NVIDIA IP RCF"]






=== Establezca las variables bootarg de MetroCluster IP

Ciertos valores de arranque IP de MetroCluster deben configurarse en los nuevos módulos de la controladora. Los valores deben coincidir con los configurados en los módulos de la controladora anteriores.

.Acerca de esta tarea
* Necesita los UUID y los ID del sistema identificados anteriormente en el procedimiento de actualización en <<gather_info_so_sb,Recopile información antes de la actualización>>.
* Según el modelo de la plataforma, puede especificar el identificador de VLAN mediante el `-vlan-id` parámetro. Las siguientes plataformas no admiten `-vlan-id` el parámetro:
+
** FAS8200 y AFF A300
** AFF A320
** FAS9000 y AFF A700
** AFF C800, ASA C800, AFF A800 y ASA A800
+
Todas las demás plataformas admiten `-vlan-id` el parámetro.



* Los valores de arranque de MetroCluster que establezca dependen de si su nuevo sistema utiliza puertos de clúster/alta disponibilidad compartidos o puertos MetroCluster/alta disponibilidad compartidos.
+
Los sistemas enumerados en la siguiente tabla utilizan *puertos MetroCluster/HA compartidos*.

+
Todos los demás sistemas utilizan *cluster compartido/puertos HA*.

+
[cols="2*"]
|===
| Sistemas AFF y ASA que utilizan puertos MetroCluster/HA compartidos | Sistemas FAS que utilizan puertos compartidos MetroCluster/HA 


 a| 
** AFF A150, ASA A150
** AFF A220
** AFF C250, ASA C250
** AFF A250, ASA A250
** AFF A300
** AFF A320
** AFF C400, ASA C400
** AFF A400, ASA A400
** A700 de AFF
** AFF C800, ASA C800
** AFF A800, ASA A800
** AFF A900, ASA A900

 a| 
** FAS2750
** FAS500f
** FAS8200
** FAS8300
** FAS8700
** FAS9000
** FAS9500


|===


.Pasos
. En la `LOADER>` Prompt, establezca los siguientes bootargs en los nuevos nodos en el site_B:
+
Los pasos que siga dependerán de los puertos que utilice el nuevo modelo de plataforma.

+
[role="tabbed-block"]
====
.Sistemas que utilizan puertos compartidos clúster/alta disponibilidad
--
.. Defina los siguientes arranques:
+
`setenv bootarg.mcc.port_a_ip_config <local-IP-address/local-IP-mask,0,0,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+
`setenv bootarg.mcc.port_b_ip_config <local-IP-address/local-IP-mask,0,0,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+

NOTE: Si las interfaces están usando un ID de VLAN predeterminado, el `vlan-id` parámetro no es necesario.

+
En el siguiente ejemplo se configuran los valores de node_B_1-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.10/23,0,0,172.17.26.13,172.17.26.12,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.10/23,0,0,172.17.27.13,172.17.27.12,130
----
+
En el siguiente ejemplo se configuran los valores de node_B_2-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.11/23,0,0,172.17.26.12,172.17.26.13,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.11/23,0,0,172.17.27.12,172.17.27.13,130
----
+
En el ejemplo siguiente se establecen los valores de node_B_1-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.10/23,0,0,172.17.26.13,172.17.26.12
setenv bootarg.mcc.port_b_ip_config
172.17.27.10/23,0,0,172.17.27.13,172.17.27.12
----
+
En el ejemplo siguiente se establecen los valores de node_B_2-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.11/23,0,0,172.17.26.12,172.17.26.13
setenv bootarg.mcc.port_b_ip_config
172.17.27.11/23,0,0,172.17.27.12,172.17.27.13
----


--
.Sistemas que usan puertos MetroCluster/HA compartidos
--
.. Defina los siguientes arranques:
+
`setenv bootarg.mcc.port_a_ip_config <local-IP-address/local-IP-mask,0,HA-partner-IP-address,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+
`setenv bootarg.mcc.port_b_ip_config <local-IP-address/local-IP-mask,0,HA-partner-IP-address,DR-partner-IP-address,DR-aux-partnerIP-address,vlan-id>`

+

NOTE: Si las interfaces están usando un ID de VLAN predeterminado, el `vlan-id` parámetro no es necesario.

+
En el siguiente ejemplo se configuran los valores de node_B_1-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.10/23,0,172.17.26.11,172.17.26.13,172.17.26.12,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.10/23,0,172.17.27.11,172.17.27.13,172.17.27.12,130
----
+
En el siguiente ejemplo se configuran los valores de node_B_2-new usando VLAN 120 para la primera red y VLAN 130 para la segunda red:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config 172.17.26.11/23,0,172.17.26.10,172.17.26.12,172.17.26.13,120
setenv bootarg.mcc.port_b_ip_config 172.17.27.11/23,0,172.17.27.10,172.17.27.12,172.17.27.13,130
----
+
En el ejemplo siguiente se establecen los valores de node_B_1-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.10/23,0,172.17.26.11,172.17.26.13,172.17.26.12
setenv bootarg.mcc.port_b_ip_config
172.17.27.10/23,0,172.17.27.11,172.17.27.13,172.17.27.12
----
+
En el ejemplo siguiente se establecen los valores de node_B_2-new mediante VLAN predeterminadas para todas las conexiones de DR IP de MetroCluster:

+
[listing]
----
setenv bootarg.mcc.port_a_ip_config
172.17.26.11/23,0,172.17.26.10,172.17.26.12,172.17.26.13
setenv bootarg.mcc.port_b_ip_config
172.17.27.11/23,0,172.17.27.10,172.17.27.12,172.17.27.13
----


--
====
. En los nuevos nodos `LOADER` Prompt, establezca los UUID:
+
`setenv bootarg.mgwd.partner_cluster_uuid <partner-cluster-UUID>`

+
`setenv bootarg.mgwd.cluster_uuid <local-cluster-UUID>`

+
`setenv bootarg.mcc.pri_partner_uuid <DR-partner-node-UUID>`

+
`setenv bootarg.mcc.aux_partner_uuid <DR-aux-partner-node-UUID>`

+
`setenv bootarg.mcc_iscsi.node_uuid <local-node-UUID>`

+
.. Establezca los UUID en node_B_1-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los UUID en node_B_1-new:

+
[listing]
----
setenv bootarg.mgwd.cluster_uuid ee7db9d5-9a82-11e7-b68b-00a098908039
setenv bootarg.mgwd.partner_cluster_uuid 07958819-9ac6-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.pri_partner_uuid f37b240b-9ac1-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.aux_partner_uuid bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f
setenv bootarg.mcc_iscsi.node_uuid f03cb63c-9a7e-11e7-b68b-00a098908039
----
.. Establezca los UUID en node_B_2-new:
+
En el ejemplo siguiente se muestran los comandos para configurar los UUID en node_B_2-new:

+
[listing]
----
setenv bootarg.mgwd.cluster_uuid ee7db9d5-9a82-11e7-b68b-00a098908039
setenv bootarg.mgwd.partner_cluster_uuid 07958819-9ac6-11e7-9b42-00a098c9e55d
setenv bootarg.mcc.pri_partner_uuid bf8e3f8f-9ac4-11e7-bd4e-00a098ca379f
setenv bootarg.mcc.aux_partner_uuid f37b240b-9ac1-11e7-9b42-00a098c9e55d
setenv bootarg.mcc_iscsi.node_uuid aa9a7a7a-9a81-11e7-a4e9-00a098908c35
----


. Determine si los sistemas originales se configuraron para la partición avanzada de unidades (ADP) ejecutando el siguiente comando desde el sitio que está activo:
+
`disk show`

+
La columna de tipo de contenedor muestra “compartido” en la `disk show` salida si ADP está configurado. Si el tipo de contenedor tiene otro valor, ADP no está configurado en el sistema. La siguiente salida de ejemplo muestra un sistema configurado con ADP:

+
[listing]
----
::> disk show
                    Usable               Disk    Container   Container
Disk                Size       Shelf Bay Type    Type        Name      Owner

Info: This cluster has partitioned disks. To get a complete list of spare disk
      capacity use "storage aggregate show-spare-disks".
----------------    ---------- ----- --- ------- ----------- --------- --------
1.11.0              894.0GB    11    0   SSD      shared     testaggr  node_A_1
1.11.1              894.0GB    11    1   SSD      shared     testaggr  node_A_1
1.11.2              894.0GB    11    2   SSD      shared     testaggr  node_A_1
----
. Si los sistemas originales se configuraron para ADP, en cada petición de datos de los nodos de sustitución `LOADER` , habilite ADP:
+
`setenv bootarg.mcc.adp_enabled true`

. Configure las siguientes variables:
+
`setenv bootarg.mcc.local_config_id <original-sys-id>`

+
`setenv bootarg.mcc.dr_partner <dr-partner-sys-id>`

+

NOTE: La `setenv bootarg.mcc.local_config_id` La variable se debe establecer en sys-id del módulo de controlador *original*, node_B_1-old.

+
.. Establezca las variables en node_B_1-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los valores en node_B_1-new:

+
[listing]
----
setenv bootarg.mcc.local_config_id 537403322
setenv bootarg.mcc.dr_partner 537403324
----
.. Establezca las variables en node_B_2-new.
+
En el ejemplo siguiente se muestran los comandos para configurar los valores en node_B_2-new:

+
[listing]
----
setenv bootarg.mcc.local_config_id 537403321
setenv bootarg.mcc.dr_partner 537403323
----


. Si utiliza cifrado con gestor de claves externo, defina los bootargs necesarios:
+
`setenv bootarg.kmip.init.ipaddr`

+
`setenv bootarg.kmip.kmip.init.netmask`

+
`setenv bootarg.kmip.kmip.init.gateway`

+
`setenv bootarg.kmip.kmip.init.interface`





=== Reasignar discos de agregado raíz

Reasigne los discos del agregado raíz al nuevo módulo de controlador mediante la `sysids` reunidos antes

.Acerca de esta tarea
Esta tarea se realiza en modo de mantenimiento.

Los ID de sistema antiguos se identificaron en <<gather_info_system_replace,Recopile información antes de la actualización>>.

Los ejemplos de este procedimiento utilizan controladoras con los siguientes ID de sistema:

|===


| Nodo | ID del sistema antiguo | Nuevo ID del sistema 


 a| 
Node_B_1
 a| 
4068741254
 a| 
1574774970

|===
.Pasos
. Conecte el resto de conexiones a los nuevos módulos de controladora (FC-VI, almacenamiento, interconexión de clúster, etc.).
. Detenga el sistema e inicie en modo de mantenimiento desde la `LOADER` prompt:
+
`boot_ontap maint`

. Muestre los discos propiedad de node_B_1-old:
+
`disk show -a`

+
El resultado del comando muestra el ID del sistema del nuevo módulo de la controladora (1574774970). Sin embargo, los discos del agregado raíz siguen siendo propiedad del ID de sistema anterior (4068741254). En este ejemplo, no se muestran las unidades que pertenecen a otros nodos en la configuración MetroCluster.

+

CAUTION: Antes de continuar con la reasignación de discos, debe verificar que la salida de los discos pool0 y pool1 que pertenecen al agregado raíz del nodo se muestren `disk show` . En el ejemplo siguiente, la salida enumera los discos pool0 y pool1 que son propiedad de node_B_1-old.

+
[listing]
----
*> disk show -a
Local System ID: 1574774970

  DISK         OWNER                     POOL   SERIAL NUMBER    HOME                      DR HOME
------------   -------------             -----  -------------    -------------             -------------
...
rr18:9.126L44 node_B_1-old(4068741254)   Pool1  PZHYN0MD         node_B_1-old(4068741254)  node_B_1-old(4068741254)
rr18:9.126L49 node_B_1-old(4068741254)   Pool1  PPG3J5HA         node_B_1-old(4068741254)  node_B_1-old(4068741254)
rr18:8.126L21 node_B_1-old(4068741254)   Pool1  PZHTDSZD         node_B_1-old(4068741254)  node_B_1-old(4068741254)
rr18:8.126L2  node_B_1-old(4068741254)   Pool0  S0M1J2CF         node_B_1-old(4068741254)  node_B_1-old(4068741254)
rr18:8.126L3  node_B_1-old(4068741254)   Pool0  S0M0CQM5         node_B_1-old(4068741254)  node_B_1-old(4068741254)
rr18:9.126L27 node_B_1-old(4068741254)   Pool0  S0M1PSDW         node_B_1-old(4068741254)  node_B_1-old(4068741254)
...
----
. Reasigne los discos de agregado raíz de las bandejas de unidades a la nueva controladora:
+
`disk reassign -s <old-sysid> -d <new-sysid>`

+

NOTE: Si el sistema IP de MetroCluster está configurado con la partición avanzada de discos, debe incluir el ID del sistema asociado de DR ejecutando el `disk reassign -s old-sysid -d new-sysid -r dr-partner-sysid` comando.

+
En el siguiente ejemplo, se muestra la reasignación de unidades:

+
[listing]
----
*> disk reassign -s 4068741254 -d 1574774970
Partner node must not be in Takeover mode during disk reassignment from maintenance mode.
Serious problems could result!!
Do not proceed with reassignment if the partner is in takeover mode. Abort reassignment (y/n)? n

After the node becomes operational, you must perform a takeover and giveback of the HA partner node to ensure disk reassignment is successful.
Do you want to continue (y/n)? Jul 14 19:23:49 [localhost:config.bridge.extra.port:error]: Both FC ports of FC-to-SAS bridge rtp-fc02-41-rr18:9.126L0 S/N [FB7500N107692] are attached to this controller.
y
Disk ownership will be updated on all disks previously belonging to Filer with sysid 4068741254.
Do you want to continue (y/n)? y
----
. Compruebe que todos los discos se reasignan según se espera:
+
`disk show`

+
[listing]
----
*> disk show
Local System ID: 1574774970

  DISK        OWNER                      POOL   SERIAL NUMBER   HOME                      DR HOME
------------  -------------              -----  -------------   -------------             -------------
rr18:8.126L18 node_B_1-new(1574774970)   Pool1  PZHYN0MD        node_B_1-new(1574774970)  node_B_1-new(1574774970)
rr18:9.126L49 node_B_1-new(1574774970)   Pool1  PPG3J5HA        node_B_1-new(1574774970)  node_B_1-new(1574774970)
rr18:8.126L21 node_B_1-new(1574774970)   Pool1  PZHTDSZD        node_B_1-new(1574774970)  node_B_1-new(1574774970)
rr18:8.126L2  node_B_1-new(1574774970)   Pool0  S0M1J2CF        node_B_1-new(1574774970)  node_B_1-new(1574774970)
rr18:9.126L29 node_B_1-new(1574774970)   Pool0  S0M0CQM5        node_B_1-new(1574774970)  node_B_1-new(1574774970)
rr18:8.126L1  node_B_1-new(1574774970)   Pool0  S0M1PSDW        node_B_1-new(1574774970)  node_B_1-new(1574774970)
*>
----
. Mostrar el estado del agregado:
+
`aggr status`

+
[listing]
----
*> aggr status
           Aggr            State       Status           Options
aggr0_node_b_1-root        online      raid_dp, aggr    root, nosnap=on,
                           mirrored                     mirror_resync_priority=high(fixed)
                           fast zeroed
                           64-bit
----
. Repita los pasos anteriores en el nodo asociado (node_B_2-new).




=== Arranque las nuevas controladoras

Debe reiniciar los controladores desde el menú de arranque para actualizar la imagen flash de la controladora. Se requieren pasos adicionales si está configurado el cifrado.

Es posible volver a configurar las VLAN y los grupos de interfaces. Si es necesario, modifique manualmente los puertos de las LIF del clúster y los detalles del dominio de retransmisión antes de reanudar la operación mediante el `system controller replace resume` comando.

.Acerca de esta tarea
Esta tarea debe realizarse en todas las controladoras nuevas.

.Pasos
. Detenga el nodo:
+
`halt`

. Si se configura el gestor de claves externo, defina los bootargs relacionados:
+
`setenv bootarg.kmip.init.ipaddr <ip-address>`

+
`setenv bootarg.kmip.init.netmask <netmask>`

+
`setenv bootarg.kmip.init.gateway <gateway-address>`

+
`setenv bootarg.kmip.init.interface <interface-id>`

. Mostrar el menú de inicio:
+
`boot_ontap menu`

. Si se utiliza el cifrado de raíz, seleccione la opción de menú de inicio para la configuración de administración de claves.
+
|===


| Si está usando... | Seleccione esta opción del menú de inicio... 


 a| 
Gestión de claves incorporada
 a| 
Opción «'10»

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.



 a| 
Gestión de claves externas
 a| 
Opción «'11»

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.

|===
. Desde el menú de inicio, ejecute la opción «'6'».
+

NOTE: La opción «'6'» reiniciará el nodo dos veces antes de completarlo.

+
Responda «'y'» a los mensajes de cambio de ID del sistema. Espere a que aparezcan los segundos mensajes de reinicio:

+
[listing]
----
Successfully restored env file from boot media...

Rebooting to load the restored env file...
----
+
Durante uno de los reinicios después de la opción “`6`”, el mensaje de confirmación `Override system ID? {y|n}` aparece. Introduzca `y`.

. Si se utiliza el cifrado de raíz, seleccione de nuevo la opción de menú de inicio para la configuración de administración de claves.
+
|===


| Si está usando... | Seleccione esta opción del menú de inicio... 


 a| 
Gestión de claves incorporada
 a| 
Opción «'10»

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.



 a| 
Gestión de claves externas
 a| 
Opción «'11»

Siga las instrucciones para proporcionar las entradas necesarias para recuperar y restaurar la configuración de Key-Manager.

|===
+
En función del ajuste del gestor de claves, realice el procedimiento de recuperación seleccionando la opción «'10'» o la opción «'11'», seguida de la opción «'6'» en el primer símbolo del sistema del menú de arranque. Para arrancar los nodos por completo, puede que necesite repetir el procedimiento de recuperación seguido de la opción «'1'» (arranque normal).

. Arrancar los nodos:
+
`boot_ontap`

. Espere a que los nodos sustituidos se inicien.
+
Si alguno de los nodos está en modo de toma de control, realice una devolución mediante el `storage failover giveback` comando.

. Verifique que todos los puertos estén en un dominio de retransmisión:
+
.. Vea los dominios de retransmisión:
+
`network port broadcast-domain show`

.. Si se crea un nuevo dominio de retransmisión para los puertos de datos en las controladoras recién actualizadas, elimine el dominio de retransmisión:
+

NOTE: Elimine sólo el nuevo dominio de difusión. No elimine ninguno de los dominios de difusión que existían antes de iniciar la actualización.

+
`broadcast-domain delete -broadcast-domain <broadcast_domain_name>`

.. Añada cualquier puerto a un dominio de retransmisión según sea necesario.
+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-003BDFCD-58A3-46C9-BF0C-BA1D1D1475F9.html["Agregar o quitar puertos de un dominio de retransmisión"^]

.. Añada el puerto físico que alojará las LIF de interconexión de clústeres en el dominio de retransmisión correspondiente.
.. Modifique las LIF de interconexión de clústeres para usar el puerto físico nuevo como puerto principal.
.. Después de poner en marcha las LIF de interconexión de clústeres, compruebe el estado de paridad del clúster y vuelva a establecer la relación de clústeres entre iguales según sea necesario.
+
Es posible que deba volver a configurar la relación de clústeres entre iguales.

+
link:../install-ip/task_sw_config_configure_clusters.html#peering-the-clusters["Creación de una relación de paridad entre clústeres"]

.. Vuelva a crear las VLAN y los grupos de interfaces según sea necesario.
+
La pertenencia a la VLAN y al grupo de interfaces puede ser diferente de la del nodo antiguo.

+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-8929FCE2-5888-4051-B8C0-E27CAF3F2A63.html["Creación de una VLAN"^]

+
https://docs.netapp.com/ontap-9/topic/com.netapp.doc.dot-cm-nmg/GUID-DBC9DEE2-EAB7-430A-A773-4E3420EE2AA1.html["Combinación de puertos físicos para crear grupos de interfaces"^]

.. Compruebe que el clúster asociado sea accesible y que la configuración se haya resincronizado correctamente en el clúster de asociado:
+
`metrocluster switchback -simulate true`



. Si se utiliza el cifrado, restaure las claves con el comando correcto para la configuración de gestión de claves.
+
|===


| Si está usando... | Se usa este comando... 


 a| 
Gestión de claves incorporada
 a| 
`security key-manager onboard sync`

Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-E4AB2ED4-9227-4974-A311-13036EB43A3D.html["Restauración de las claves de cifrado de gestión de claves incorporadas"^].



 a| 
Gestión de claves externas
 a| 
`security key-manager external restore -vserver <svm-name> -node <node-name> -key-server <host_name|IP_address:port> -key-id <key_id> -key-tag key_tag <node-name>`

Para obtener más información, consulte https://docs.netapp.com/ontap-9/topic/com.netapp.doc.pow-nve/GUID-32DA96C3-9B04-4401-92B8-EAF323C3C863.html["Restauración de claves de cifrado de gestión de claves externas"^].

|===
. Compruebe que MetroCluster está configurado correctamente. Compruebe el estado del nodo:
+
`metrocluster node show`

+
Verifique que los nuevos nodos (site_B) estén en *esperando el estado de regreso* desde el sitio_A.





=== Verifique y restaure la configuración de LIF

Compruebe que las LIF están alojadas en los nodos adecuados antes de continuar con la operación de conmutación de estado automática.

.Acerca de esta tarea
* Esta tarea se realiza en el sitio_B.



CAUTION: Debe verificar que la ubicación de las LIF de datos sea correcta en los nodos nuevos antes de volver a cambiar. Cuando conmuta la configuración, ONTAP intenta reanudar el tráfico en el puerto de inicio que utilizan las LIF. Se puede producir un fallo de E/S cuando la conexión del puerto de inicio al puerto del switch y la VLAN es incorrecta.

.Pasos
. Compruebe que las LIF están alojadas en el nodo y los puertos adecuados antes de volver a cambiar.
+
.. Cambie al nivel de privilegio avanzado:
+
`set -privilege advanced`

.. Muestre las LIF y confirme que cada LIF de datos está utilizando el puerto de inicio correcto:
+
`network interface show`

.. Modifique los LIF que no estén utilizando el puerto raíz correcto:
+
`network interface modify -vserver <svm-name> -lif <data-lif> -home-port <port-id>`

+
Si el comando devuelve un error, puede anular la configuración del puerto:

+
`vserver config override -command "network interface modify -vserver <svm-name> -home-port <active_port_after_upgrade> -lif <lif_name> -home-node <new_node_name>"`

+
Al introducir el comando de modificación de la interfaz de red dentro del `vserver config override` no se puede utilizar la función de tabulación automática. Puede crear la red `interface modify` con la opción de autocompletar y, a continuación, escríbala en la `vserver config override` comando.

.. Confirme que todas las LIF de datos se encuentran ahora en el puerto de inicio correcto:
+
`network interface show`

.. Vuelva al nivel de privilegio de administrador:
+
`set -privilege admin`



. Revierte las interfaces a su nodo de inicio:
+
`network interface revert * -vserver <svm-name>`

+
Realice este paso en todas las SVM según sea necesario.

. Reanude la operación:
+
`system controller replace resume`





== Complete la actualización

La operación de automatización ejecuta comprobaciones del sistema de verificación y, a continuación, pausa para poder verificar la accesibilidad de la red. Después de la verificación, se inicia la fase de recuperación de recursos y la operación de automatización ejecuta la conmutación de estado del sitio A y se pausa en las comprobaciones posteriores a la actualización. Después de reanudar la operación de automatización, se realizan las comprobaciones posteriores a la actualización y, si no se detectan errores, Marca la actualización como completada.

.Pasos
. Compruebe la accesibilidad de la red siguiendo el mensaje de la consola.
. Una vez finalizada la verificación, reanude la operación:
+
`system controller replace resume`

. La operación de automatización realiza `heal-aggregate`, `heal-root-aggregate`, Y operaciones de conmutación en el sitio A, y las comprobaciones posteriores a la actualización. Cuando se pausa la operación, compruebe manualmente el estado de LIF DE SAN y compruebe la configuración de red siguiendo el mensaje de la consola.
. Una vez finalizada la verificación, reanude la operación:
+
`system controller replace resume`

. Compruebe el estado de las comprobaciones posteriores a la actualización:
+
`system controller replace show`

+
Si las comprobaciones posteriores a la actualización no informaron de ningún error, se completó la actualización.

. Una vez finalizada la actualización de la controladora, inicie sesión en el sitio B y compruebe que las controladoras sustituidas estén configuradas correctamente.




=== Vuelva a configurar ONTAP Mediator

Configure manualmente ONTAP Mediator que se eliminó automáticamente antes de iniciar la actualización.

. Utilice los pasos de link:../install-ip/task_configuring_the_ontap_mediator_service_from_a_metrocluster_ip_configuration.html["Configure el servicio Mediador ONTAP desde una configuración IP de MetroCluster"].




=== Supervisión de tiebreaker para restaurar

Si la configuración de MetroCluster se ha configurado previamente para la supervisión por parte del software Tiebreaker, puede restaurar la conexión de tiebreaker.

. Utilice los pasos de http://docs.netapp.com/ontap-9/topic/com.netapp.doc.hw-metrocluster-tiebreaker/GUID-7259BCA4-104C-49C6-BAD0-1068CA2A3DA5.html["Adición de configuraciones de MetroCluster"].




=== Configurar el cifrado integral

Si es compatible con su sistema, puede cifrar el tráfico de back-end, como NVlog y los datos de replicación de almacenamiento, entre los sitios IP de MetroCluster. Consulte link:../maintain/task-configure-encryption.html["Configurar el cifrado integral"] si quiere más información.
